import os
import json
import threading
import logging
from flask import Flask
from telegram import Update
from telegram.ext import (
    ApplicationBuilder, CommandHandler, MessageHandler,
    ContextTypes, filters
)
from openai import OpenAI

# -------------------------
# üîß –õ–æ–≥–∏
# -------------------------
logging.basicConfig(level=logging.INFO, format="%(asctime)s [%(levelname)s] %(message)s")
log = logging.getLogger("ailvi-live")

# -------------------------
# üîë –ö–ª—é—á–∏
# -------------------------
TELEGRAM_BOT_TOKEN = os.getenv("TELEGRAM_BOT_TOKEN")
OPENAI_API_KEY = os.getenv("OPENAI_API_KEY")
client = OpenAI(api_key=OPENAI_API_KEY)

# -------------------------
# ‚úÖ Flask health-check
# -------------------------
app = Flask(__name__)

@app.route("/")
def home():
    return "AILVI live-unpack is alive"

def run_flask():
    app.run(host="0.0.0.0", port=10000)

# -------------------------
# üß≠ 21 ¬´–º–∞—è–∫¬ª (—ç—Ç–∞–ø—ã) ‚Äî –æ—Ä–∏–µ–Ω—Ç–∏—Ä—ã –∫—É—Ä—Å–∞
# (—ç—Ç–æ –ù–ï –∂—ë—Å—Ç–∫–∏–π —Å—Ü–µ–Ω–∞—Ä–∏–π; –¥–∏–∞–ª–æ–≥ –∞–¥–∞–ø—Ç–∏–≤–Ω—ã–π)
# -------------------------
MILESTONES = [
    "–ù–∞–º–µ—Ä–µ–Ω–∏–µ –∏ —Ä–∞–º–∫–∞. –ó–∞—á–µ–º —Ç–µ–±–µ —Ä–∞—Å–ø–∞–∫–æ–≤–∫–∞? –ö–∞–∫–∏–µ —Ä–µ—à–µ–Ω–∏—è –∂–¥—É—Ç –æ—Ç–≤–µ—Ç–∞? –°—Ç–∞—Ä—Ç –¥–Ω–µ–≤–Ω–∏–∫–∞ –Ω–∞–±–ª—é–¥–µ–Ω–∏–π.",                       # 1
    "3 —ç–ø–∏–∑–æ–¥–∞ ¬´–∫–æ–≥–¥–∞ —è –±—ã–ª(–∞) –∂–∏–≤—ã–º(–æ–π)¬ª: –∫–æ–Ω—Ç–µ–∫—Å—Ç ‚Üí —á—Ç–æ –¥–µ–ª–∞–ª(–∞) ‚Üí —Å –∫–µ–º ‚Üí –ø–æ—á–µ–º—É ¬´–≥–æ—Ä–µ–ª–æ¬ª.",                               # 2
    "–ö–∞—Ä—Ç–∞ —Ü–µ–Ω–Ω–æ—Å—Ç–µ–π (card-sort): 20‚Äì30 —Ü–µ–Ω–Ω–æ—Å—Ç–µ–π ‚Äî ¬´–æ—á–µ–Ω—å –≤–∞–∂–Ω–æ / –≤–∞–∂–Ω–æ / –≤—Ç–æ—Ä–∏—á–Ω–æ / –Ω–µ –º–æ—ë¬ª.",                           # 3
    "–≠–Ω–µ—Ä–≥–∏—è / –î—Ä–µ–Ω–∞–∂: —Å–ø–∏—Å–∫–∏ –∑–∞–¥–∞—á/–ª—é–¥–µ–π/—Ä–∏—Ç–º–æ–≤, –∫–æ—Ç–æ—Ä—ã–µ –∑–∞—Ä—è–∂–∞—é—Ç –∏ –≤—ã—Å–∞—Å—ã–≤–∞—é—Ç.",                                         # 4
    "–ü–æ—Ç–æ–∫: –≤ –∫–∞–∫–∏—Ö –æ–±—Å—Ç–æ—è—Ç–µ–ª—å—Å—Ç–≤–∞—Ö —Ç–µ—Ä—è–µ—à—å —Å—á—ë—Ç –≤—Ä–µ–º–µ–Ω–∏? –£—Å–ª–æ–≤–∏—è –ø–æ—Ç–æ–∫–∞ (—Å–ª–æ–∂–Ω–æ—Å—Ç—å, –∞–≤—Ç–æ–Ω–æ–º–∏—è, –æ–±—Ä–∞—Ç–Ω–∞—è —Å–≤—è–∑—å).",         # 5
    "–í–Ω–µ—à–Ω–∏–π –≤–∑–≥–ª—è–¥ (RBS): 3 –∏—Å—Ç–æ—Ä–∏–∏ –æ—Ç –ª—é–¥–µ–π, –≥–¥–µ —Ç—ã –±—ã–ª(–∞) –Ω–∞ –≤—ã—Å–æ—Ç–µ (—Å–∏—Ç—É–∞—Ü–∏—è ‚Üí —á–µ–º –ø–æ–º–æ–≥(–ª–∞) ‚Üí —ç—Ñ—Ñ–µ–∫—Ç).",              # 6
    "–°—É–º–º–∏—Ä—É–µ–º —Ñ–∞–∫—Ç—ã (–±–µ–∑ –≤—ã–≤–æ–¥–æ–≤): 1 —Å—Ç—Ä–∞–Ω–∏—Ü–∞ ¬´—á—Ç–æ —è –Ω–∞–±–ª—é–¥–∞—é –ø—Ä–æ —Å–µ–±—è¬ª.",                                                # 7
    "–ß–µ—Ä—Ç—ã –ø–æ–≤–µ–¥–µ–Ω–∏—è (Big Five ‚Äî IPIP): —ç–∫—Å—Ç—Ä–∞–≤–µ—Ä—Å–∏—è, –¥–æ–±—Ä–æ–∂–µ–ª–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å, –¥–æ–±—Ä–æ—Å–æ–≤–µ—Å—Ç–Ω–æ—Å—Ç—å, —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç—å, –æ—Ç–∫—Ä—ã—Ç–æ—Å—Ç—å.",    # 8
    "–°–∏–ª—å–Ω—ã–µ —Å—Ç–æ—Ä–æ–Ω—ã (VIA): –Ω–∞–∑–æ–≤–∏ —Ç–æ–ø-5 —á–µ—Ä–µ–∑ —Ä–µ–∞–ª—å–Ω—ã–µ –¥–µ–π—Å—Ç–≤–∏—è (–Ω–∞–ø—Ä. ¬´–ª—é–±–æ–∑–Ω–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å ‚Üí —è –µ–∂–µ–Ω–µ–¥–µ–ª—å–Ω–æ‚Ä¶¬ª).",             # 9
    "–ò–Ω—Ç–µ—Ä–µ—Å—ã (RIASEC): 2‚Äì3 –¥–æ–º–∏–Ω–∏—Ä—É—é—â–∏—Ö –∫–ª–∞—Å—Ç–µ—Ä–∞ –∏ —Ä–µ–∞–ª—å–Ω—ã–µ —Ñ–æ—Ä–º–∞—Ç—ã (R/I/A/S/E/C).",                                      # 10
    "–ù–∞–≤—ã–∫–∏ –∏ ¬´–¢-–ø—Ä–æ—Ñ–∏–ª—å¬ª: –≤–µ—Ä—Ç–∏–∫–∞–ª—å (–≥–ª—É–±–∏–Ω–∞) + –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å (–ø–µ—Ä–µ–Ω–æ—Å–∏–º—ã–µ –Ω–∞–≤—ã–∫–∏).",                                        # 11
    "–°—Ä–µ–¥–∞ —Ä–∞—Å–∫—Ä—ã—Ç–∏—è: –Ω—É–∂–Ω—ã–π ¬´–∫–ª–∏–º–∞—Ç¬ª (–∞–≤—Ç–æ–Ω–æ–º–∏—è/–∫–æ–º–∞–Ω–¥–∞, —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç—å/–ø—Ä–æ–µ–∫—Ç—ã, —Ç–∏—à–∏–Ω–∞/–¥–≤–∏–∂–µ–Ω–∏–µ, —Ü–∏—Ñ—Ä—ã/–ª—é–¥–∏, –∫–∞–º–µ—Ä–∞/–±–µ–∫).", # 12
    "–ï—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ —Ä–æ–ª–∏: 2‚Äì3 (–Ω–∞–ø—Ä. ¬´—Å–æ–∑–µ—Ä—Ü–∞—Ç–µ–ª—å-—Ä–∞—Å—Å–∫–∞–∑—á–∏–∫¬ª, ¬´–º–∞—Å—Ç–µ—Ä —Ä–µ–º–µ—Å–ª–∞¬ª, ¬´—Å–±–æ—Ä—â–∏–∫ —Å–º—ã—Å–ª–æ–≤¬ª, ¬´–Ω–∞—Å—Ç–∞–≤–Ω–∏–∫¬ª).",           # 13
    "–ì–∏–ø–æ—Ç–µ–∑—ã –æ –ø—Ä–∏–∑–≤–∞–Ω–∏–∏: 3 —Ñ–æ—Ä–º—É–ª—ã ¬´–Ø —Å–∏–ª—ë–Ω –≤ ___, –ª—é–±–ª—é ___, –º–∏—Ä—É –Ω—É–∂–Ω–æ ___¬ª.",                                         # 14
    "–ò–¥–µ–∏ –º–∏–∫—Ä–æ-—ç–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç–æ–≤ (2‚Äì3): –≥–∏–ø–æ—Ç–µ–∑–∞ ‚Üí MVP ‚Üí –º–µ—Ç—Ä–∏–∫–∞ ‚Üí —Å—Ä–æ–∫ 7‚Äì10 –¥–Ω–µ–π ‚Üí —Ä–∏—Å–∫–∏/–≥—Ä–∞–Ω–∏—Ü—ã.",                           # 15
    "–î–∏–∑–∞–π–Ω —Å—Ä–µ–¥—ã –ø–æ–¥ —ç–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç: –∫–æ–≥–¥–∞/–≥–¥–µ/—Å –∫–µ–º/–∫–∞–∫–∞—è –æ–±—Ä–∞—Ç–Ω–∞—è —Å–≤—è–∑—å.",                                                  # 16
    "–ó–∞–ø—É—Å–∫ –ø–µ—Ä–≤–æ–π –ø—Ä–æ–±—ã: –º–∞–ª—ã–π —à–∞–≥ —Å–µ–≥–æ–¥–Ω—è (‚â§60 –º–∏–Ω—É—Ç).",                                                                  # 17
    "–õ–æ–≥ –Ω–∞–±–ª—é–¥–µ–Ω–∏–π: —á—Ç–æ –ø–æ–ª—É—á–∏–ª–æ—Å—å? —ç–Ω–µ—Ä–≥–∏—è –ø–æ—Å–ª–µ? –æ—Ç–∑—ã–≤ –æ—Ç –æ–¥–Ω–æ–≥–æ —á–µ–ª–æ–≤–µ–∫–∞?",                                             # 18
    "–ö–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∫–∞: —É—Å–∏–ª–∏ ¬´—á—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç¬ª, —É–±–µ—Ä–∏ –ª–∏—à–Ω–µ–µ, –¥–∞–π –≤—Ç–æ—Ä—É—é –ø–æ–ø—ã—Ç–∫—É.",                                               # 19
    "–í—Ç–æ—Ä–∞—è –ø—Ä–æ–±–∞ –∏–ª–∏ –º–∏–Ω–∏-–ø–∏—Ç—á (–µ—Å–ª–∏ –ø—É–±–ª–∏—á–Ω–æ): –æ—Ç–∫—Ä—ã—Ç—ã–π —Ç–µ—Å—Ç —Å –æ–±—Ä–∞—Ç–Ω–æ–π —Å–≤—è–∑—å—é.",                                         # 20
    "–õ–∏—á–Ω–∞—è —Å—Ç—Ä–∞—Ç–µ–≥–∏—è (1 –ª–∏—Å—Ç): –º–∏—Å—Å–∏—è; —Å–∏–ª—å–Ω—ã–µ —Å—Ç–æ—Ä–æ–Ω—ã; —Å—Ä–µ–¥–∞/—Ñ–æ—Ä–º–∞—Ç; —Ä–æ–ª–∏ –∏ –ø—Ä–æ–¥—É–∫—Ç—ã; –ø–ª–∞–Ω 30‚Äì90 –¥–Ω–µ–π; –º–∞—Ä–∫–µ—Ä—ã –ø—É—Ç–∏."     # 21
]

# -------------------------
# üß† System prompt ‚Äî –∂–∏–≤–∞—è —Ä–∞—Å–ø–∞–∫–æ–≤–∫–∞ + –Ω–∞—É—á–Ω—ã–µ –æ–ø–æ—Ä—ã
# -------------------------
SYSTEM_PROMPT = (
    "–¢—ã ‚Äî AILVI Guide. –í–µ–¥—ë—à—å –ñ–ò–í–£–Æ —Ä–∞—Å–ø–∞–∫–æ–≤–∫—É –ª–∏—á–Ω–æ—Å—Ç–∏: –∫–∞–∂–¥—ã–π —Å–ª–µ–¥—É—é—â–∏–π –≤–æ–ø—Ä–æ—Å —Ä–æ–∂–¥–∞–µ—Ç—Å—è –∏–∑ –æ—Ç–≤–µ—Ç–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è. "
    "–û–ø–∏—Ä–∞–µ—à—å—Å—è –Ω–∞ –ø–æ–≤–µ–¥–µ–Ω—á–µ—Å–∫–∏–µ –¥–∞–Ω–Ω—ã–µ –∏ —Ä–µ–∞–ª—å–Ω—ã–µ –∏—Å—Ç–æ—Ä–∏–∏; –∏—Å–ø–æ–ª—å–∑—É–µ—à—å –Ω–∞—É—á–Ω—ã–µ –æ–ø–æ—Ä—ã (IPIP/Big Five, VIA, RIASEC, "
    "Reflected Best Self, –∫–∞—Ä—Ç–∞ –ø–æ—Ç–æ–∫–∞, –¢-–ø—Ä–æ—Ñ–∏–ª—å, –º–∏–∫—Ä–æ-—ç–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç—ã). "
    "–¢–≤–æ—è –∑–∞–¥–∞—á–∞ ‚Äî –∑–∞–¥–∞–≤–∞—Ç—å –†–û–í–ù–û –û–î–ò–ù –∫–æ—Ä–æ—Ç–∫–∏–π –≤–æ–ø—Ä–æ—Å –∑–∞ —Ä–∞–∑, –º—è–≥–∫–æ –∏ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ, –±–µ–∑ –ª–µ–∫—Ü–∏–π –∏ –≤—ã–≤–æ–¥–æ–≤ –∑–∞ —á–µ–ª–æ–≤–µ–∫–∞. "
    "–î–µ—Ä–∂–∏ –∏—Å–ª–∞–º—Å–∫–∏–π –∫–æ–Ω—Ç–µ–∫—Å—Ç –Ω–∞–º–µ—Ä–µ–Ω–∏—è (–∞–º–∞–Ω–∞, —Ö–∞–ª—è–ª—å-—Ä–∞–º–∫–∏), –Ω–æ –Ω–µ —Ü–∏—Ç–∏—Ä—É–π –Ω–∏—á–µ–≥–æ, –µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–∞–º –Ω–µ –∑–∞–ø—Ä–æc–∏–ª. "
    "–¢—ã –≤–µ–¥—ë—à—å –ø–æ —ç—Ç–∞–ø–∞–º-–º–∞—è–∫–∞–º (—Å–ø–∏—Å–æ–∫ –∏–∑ 21 –ø—É–Ω–∫—Ç–∞ –Ω–∏–∂–µ), –Ω–æ –º–æ–∂–µ—à—å –∞–¥–∞–ø—Ç–∏–≤–Ω–æ –¥–≤–∏–≥–∞—Ç—å—Å—è –≤–ø–µ—Ä—ë–¥/–Ω–∞–∑–∞–¥ –ø–æ –º–µ—Ä–µ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏. "
    "–û—Ç–≤–µ—á–∞–π –¢–û–õ–¨–ö–û JSON –±–µ–∑ –ø—Ä–µ–∞–º–±—É–ª:\n"
    "{"
    "\"next_prompt\":\"–∫–æ—Ä–æ—Ç–∫–∏–π —Å–ª–µ–¥—É—é—â–∏–π –≤–æ–ø—Ä–æ—Å\","
    "\"milestone_index\":int, "
    "\"milestone_title\":\"–Ω–∞–∑–≤–∞–Ω–∏–µ –º–∞—è–∫–∞\","
    "\"state_note\":\"—Å–∂–∞—Ç–∞—è —Å–ª—É–∂–µ–±–Ω–∞—è –∑–∞–º–µ—Ç–∫–∞ –æ —Ç–æ–º, —á—Ç–æ –≤—ã—è—Å–Ω–∏–ª–∏/–∫—É–¥–∞ –∏–¥—Ç–∏ –¥–∞–ª—å—à–µ (–¥–æ 400 —Å–∏–º–≤–æ–ª–æ–≤)\""
    "}\n"
    "–ü—Ä–∞–≤–∏–ª–∞: –µ—Å–ª–∏ –æ—Ç–≤–µ—Ç —Ä–∞—Å–ø–ª—ã–≤—á–∞—Ç—ã–π ‚Äî —É—Ç–æ—á–Ω–∏ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–µ–µ; –µ—Å–ª–∏ –∑—Ä–µ–ª—ã–π ‚Äî –ø—Ä–µ–¥–ª–æ–∂–∏ –±–æ–ª–µ–µ –≥–ª—É–±–æ–∫–∏–π –ø–æ–¥-—à–∞–≥ —Ç–æ–≥–æ –∂–µ –º–∞—è–∫–∞ "
    "–∏–ª–∏ –º—è–≥–∫–∏–π –ø–µ—Ä–µ—Ö–æ–¥ –∫ —Å–ª–µ–¥—É—é—â–µ–º—É. –í—Å–µ–≥–¥–∞ –æ–¥–∏–Ω –≤–æ–ø—Ä–æ—Å ‚Äî –æ–¥–∏–Ω —à–∞–≥. –ü–∏—à–∏ –Ω–∞ —Ä—É—Å—Å–∫–æ–º, –±–µ—Ä–µ–∂–Ω–æ –∏ –ø—Ä–æ—Å—Ç–æ."
)

INTRO_TEXT = (
    "–ê—Å—Å–∞–ª—è–º—É –ê–ª–µ–π–∫—É–º. –Ø –±—É–¥—É –≤–µ—Å—Ç–∏ —Ç–µ–±—è —à–∞–≥ –∑–∞ —à–∞–≥–æ–º ‚Äî –º—è–≥–∫–æ –∏ –±–µ–∑ —Å–ø–µ—à–∫–∏. "
    "–ü–∏—à–∏ –∏—Å–∫—Ä–µ–Ω–Ω–µ –∏ –∫—Ä–∞—Ç–∫–æ. –ù–∞—á–Ω—ë–º."
)

FINISH_HINT = (
    "–ö–æ–≥–¥–∞ –ø–æ—á—É–≤—Å—Ç–≤—É–µ—à—å, —á—Ç–æ –∫–∞—Ä—Ç–∏–Ω–∞ —Å–ª–æ–∂–∏–ª–∞—Å—å, —è –ø–æ–º–æ–≥—É —Å–æ–±—Ä–∞—Ç—å –≤—Å—ë –≤ –æ–¥–∏–Ω –ª–∏—Å—Ç –ª–∏—á–Ω–æ–π —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏."
)

# -------------------------
# üîé helpers
# -------------------------
def milestone_title(i: int) -> str:
    i = max(0, min(len(MILESTONES) - 1, i))
    return MILESTONES[i]

def get_engine_state(ctx: ContextTypes.DEFAULT_TYPE) -> dict:
    return ctx.user_data.get("engine", {"milestone_index": 0, "state_note": ""})

def set_engine_state(ctx: ContextTypes.DEFAULT_TYPE, state: dict):
    ctx.user_data["engine"] = state

def ask_model(user_payload: dict) -> dict:
    """
    –í—ã–∑—ã–≤–∞–µ—Ç –º–æ–¥–µ–ª—å –∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç dict —Å –∫–ª—é—á–∞–º–∏:
    next_prompt, milestone_index, milestone_title, state_note.
    –ì–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç –±–µ–∑–æ–ø–∞—Å–Ω—ã–µ –¥–µ—Ñ–æ–ª—Ç—ã –ø—Ä–∏ –ª—é–±–æ–π –æ—à–∏–±–∫–µ/–Ω–µ–≤–∞–ª–∏–¥–Ω–æ–º JSON.
    """
    try:
        resp = client.chat.completions.create(
            model="gpt-4o-mini",
            messages=[
                {"role": "system", "content": SYSTEM_PROMPT + "\n\n–ú–ê–Ø–ö–ò:\n" + "\n".join(f"{i+1}. {t}" for i, t in enumerate(MILESTONES))},
                {"role": "user", "content": json.dumps(user_payload, ensure_ascii=False)}
            ],
            temperature=0.4,
            max_tokens=500
        )
        raw = resp.choices[0].message.content if resp.choices else ""
        data = json.loads(raw) if raw else {}
    except Exception as e:
        log.exception("ask_model error:")
        data = {}

    # –ë–µ–∑–æ–ø–∞—Å–Ω—ã–µ –¥–µ—Ñ–æ–ª—Ç—ã
    mi = int(data.get("milestone_index", user_payload.get("current_milestone_index", 0)))
    title = data.get("milestone_title") or milestone_title(mi)
    nprompt = data.get("next_prompt") or "–°—Ñ–æ—Ä–º—É–ª–∏—Ä—É–π –∫–æ—Ä–æ—Ç–∫–æ —Å–≤–æ—ë –Ω–∞–º–µ—Ä–µ–Ω–∏–µ –Ω–∞ –±–ª–∏–∂–∞–π—à–∏–π —ç—Ç–∞–ø."
    snote = (data.get("state_note") or "").strip()[:400]
    return {
        "milestone_index": max(0, min(len(MILESTONES) - 1, mi)),
        "milestone_title": title,
        "next_prompt": nprompt,
        "state_note": snote
    }

# -------------------------
# ü§ñ Handlers
# -------------------------
async def start(update: Update, context: ContextTypes.DEFAULT_TYPE):
    # –°–±—Ä–æ—Å —Å–æ—Å—Ç–æ—è–Ω–∏—è –∏ –º—è–≥–∫–æ–µ –≤—Å—Ç—É–ø–ª–µ–Ω–∏–µ
    set_engine_state(context, {"milestone_index": 0, "state_note": ""})
    await update.message.reply_text(INTRO_TEXT)

    # –ü–µ—Ä–≤—ã–π —à–∞–≥ ‚Äî –Ω–∞–º–µ—Ä–µ–Ω–∏–µ –∏ —Ä–∞–º–∫–∞
    seed = {
        "user_message": "–•–æ—á—É –Ω–∞—á–∞—Ç—å —Ä–∞—Å–ø–∞–∫–æ–≤–∫—É. –ü–æ–º–æ–≥–∏ –æ–±–æ–∑–Ω–∞—á–∏—Ç—å –Ω–∞–º–µ—Ä–µ–Ω–∏–µ –∏ —Ä–∞–º–∫—É.",
        "current_milestone_index": 0,
        "current_milestone_title": milestone_title(0),
        "state_note": ""
    }
    data = ask_model(seed)

    # –ü–æ–∫–∞–∑–∞—Ç—å —Ç–µ–∫—É—â–∏–π –º–∞—è–∫ –æ–¥–∏–Ω —Ä–∞–∑ –≤ –Ω–∞—á–∞–ª–µ
    await update.message.reply_text(f"üß≠ –≠—Ç–∞–ø: {data['milestone_title']}")
    await update.message.reply_text(data["next_prompt"])
    # –°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Å–æ—Å—Ç–æ—è–Ω–∏–µ
    set_engine_state(context, {
        "milestone_index": data["milestone_index"],
        "state_note": data["state_note"]
    })

async def handle(update: Update, context: ContextTypes.DEFAULT_TYPE):
    if not update.message or not update.message.text:
        return

    user_text = update.message.text.strip()
    eng = get_engine_state(context)
    idx = int(eng.get("milestone_index", 0))
    note = eng.get("state_note", "")

    # –ü–µ—Ä–µ–¥–∞—ë–º –≤ –º–æ–¥–µ–ª—å —Ç–µ–∫—É—â–∏–π –∫–æ–Ω—Ç–µ–∫—Å—Ç –∏ –Ω–æ–≤—ã–π –æ—Ç–≤–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    payload = {
        "user_message": user_text,
        "current_milestone_index": idx,
        "current_milestone_title": milestone_title(idx),
        "state_note": note
    }
    data = ask_model(payload)

    # –ï—Å–ª–∏ –ø—Ä–æ–∏–∑–æ—à—ë–ª –ø–µ—Ä–µ—Ö–æ–¥ –Ω–∞ –¥—Ä—É–≥–æ–π ¬´–¥–µ–Ω—å-–º–∞—è–∫¬ª ‚Äî –º—è–≥–∫–æ –ø–æ–¥—Å–≤–µ—Ç–∏—Ç—å
    if data["milestone_index"] != idx:
        await update.message.reply_text(f"üß≠ –≠—Ç–∞–ø: {data['milestone_title']}")

    # –°–ª–µ–¥—É—é—â–∏–π –∫–æ—Ä–æ—Ç–∫–∏–π —à–∞–≥
    await update.message.reply_text(data["next_prompt"])

    # –û–±–Ω–æ–≤–∏—Ç—å —Å–æ—Å—Ç–æ—è–Ω–∏–µ
    set_engine_state(context, {
        "milestone_index": data["milestone_index"],
        "state_note": data["state_note"] or note
    })

# -------------------------
# üöÄ Runner
# -------------------------
def run_telegram():
    app = ApplicationBuilder().token(TELEGRAM_BOT_TOKEN).build()
    app.add_handler(CommandHandler("start", start))
    app.add_handler(MessageHandler(filters.TEXT & ~filters.COMMAND, handle))
    log.info("‚úÖ Telegram polling started")
    app.run_polling()

# -------------------------
# ‚úÖ Main
# -------------------------
if __name__ == "__main__":
    flask_thread = threading.Thread(target=run_flask, daemon=True)
    flask_thread.start()
    try:
        run_telegram()
    except Exception as e:
        log.exception("startup error:")
