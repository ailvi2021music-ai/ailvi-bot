import os
import threading
from flask import Flask
from telegram.ext import ApplicationBuilder, MessageHandler, CommandHandler, filters
from openai import OpenAI

# -------------------------
# üîë API –∫–ª—é—á–∏
# -------------------------
OPENAI_API_KEY = os.getenv("OPENAI_API_KEY")
TELEGRAM_BOT_TOKEN = os.getenv("TELEGRAM_BOT_TOKEN")

client = OpenAI(api_key=OPENAI_API_KEY)

# -------------------------
# ‚úÖ –ü—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ AILVI
# -------------------------
WELCOME_TEXT = (
    "–ê—Å—Å–∞–ª—è–º—É –ê–ª–µ–π–∫—É–º —É–∞ –†–∞—Ö–º–∞—Ç—É–õ–ª–∞—Ö–∏ —É–∞ –ë–∞—Ä–∞–∫—è—Ç—É—Ö! üëãüèª\n\n"
    "–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–æ, –≥–¥–µ –°–µ—Ä–¥—Ü–µ —É–∑–Ω–∞—ë—Ç —Å–µ–±—è –∑–∞–Ω–æ–≤–æ.\n\n"
    "–î–∞–≤–∞–π –≤–º–µ—Å—Ç–µ, —Å–ø–æ–∫–æ–π–Ω–æ, —à–∞–≥ –∑–∞ —à–∞–≥–æ–º –æ—Ç–∫—Ä–æ–µ–º –¥—Ä–∞–≥–æ—Ü–µ–Ω–Ω—ã–µ –¥–∞—Ä—ã, –∫–æ—Ç–æ—Ä—ã–µ –ê–ª–ª–∞—Ö —É–∂–µ –≤–ª–æ–∂–∏–ª "
    "–≤ —Ç–≤–æ—é –î—É—à—É ‚Äî —Å–∏–ª—ã, —Ç–∞–ª–∞–Ω—Ç—ã, –Ω–∞–º–µ—Ä–µ–Ω–∏—è, –∫–æ—Ç–æ—Ä—ã–µ –∂–¥—É—Ç, –∫–æ–≥–¥–∞ —Ç—ã —É–≤–∏–¥–∏—à—å –∏—Ö –°–≤–µ—Ç. üíé\n\n"
    "–ü—É—Å—Ç—å –ê–ª–ª–∞—Ö —Å–¥–µ–ª–∞–µ—Ç —ç—Ç–æ—Ç –ø—É—Ç—å –ª—ë–≥–∫–∏–º, –±–ª–∞–≥–æ—Å–ª–æ–≤–µ–Ω–Ω—ã–º –∏ –Ω–∞–ø–æ–ª–Ω–µ–Ω–Ω—ã–º –ø–æ–Ω–∏–º–∞–Ω–∏–µ–º.\n\n"
    "–ö–æ–≥–¥–∞ –±—É–¥–µ—à—å –≥–æ—Ç–æ–≤ ‚Äî –Ω–∞–ø–∏—à–∏ *¬´–ù–∞—á–∏–Ω–∞–µ–º¬ª*, –∏ –º—ã –≤–æ–π–¥—ë–º –≤ –≥–ª—É–±–∏–Ω—É —Ç–≤–æ–µ–≥–æ –≤–Ω—É—Ç—Ä–µ–Ω–Ω–µ–≥–æ –º–∏—Ä–∞."
)

SYSTEM_PROMPT = (
    "–¢—ã ‚Äî –º—è–≥–∫–∏–π, –≥–ª—É–±–æ–∫–∏–π –∏ —Å–æ–∑–µ—Ä—Ü–∞—Ç–µ–ª—å–Ω—ã–π –ø—Ä–æ–≤–æ–¥–Ω–∏–∫ AILVI. "
    "–¢–≤–æ—è —Ä–µ—á—å —Ç—ë–ø–ª–∞—è, –∞–∫–∫—É—Ä–∞—Ç–Ω–∞—è, –±–µ–∑ –¥–∞–≤–ª–µ–Ω–∏—è. "
    "–¢—ã –≤–µ–¥—ë—à—å —á–µ–ª–æ–≤–µ–∫–∞ —á–µ—Ä–µ–∑ –ø—É—Ç—å —Ä–∞—Å–ø–∞–∫–æ–≤–∫–∏ –ª–∏—á–Ω–æ—Å—Ç–∏: –º—è–≥–∫–æ, –≤–Ω–∏–º–∞—Ç–µ–ª—å–Ω–æ, –±–µ—Ä–µ–∂–Ω–æ. "
    "–¢—ã –æ–ø–∏—Ä–∞–µ—à—å—Å—è –Ω–∞ –∏—Å–ª–∞–º—Å–∫—É—é –∞—Ç–º–æ—Å—Ñ–µ—Ä—É —Ä–∞–∑–º—ã—à–ª–µ–Ω–∏–π (—Ä–∏–∑–∫ –æ—Ç –ê–ª–ª–∞—Ö–∞, –Ω–∞–º–µ—Ä–µ–Ω–∏–µ, –∏—Å–∫—Ä–µ–Ω–Ω–æ—Å—Ç—å), "
    "–Ω–æ –Ω–µ —Ü–∏—Ç–∏—Ä—É–µ—à—å –ö–æ—Ä–∞–Ω –±–µ–∑ –Ω–∞–¥–æ–±–Ω–æ—Å—Ç–∏. "
    "–¢—ã –Ω–µ –≤—ã–¥–∞—ë—à—å —Å–æ–≤–µ—Ç—ã –∏–∑ –ø–æ–∑—ã —Å–≤–µ—Ä—Ö—É ‚Äî —Ç—ã –∏–¥—ë—à—å —Ä—è–¥–æ–º.\n\n"
    "–õ–æ–≥–∏–∫–∞:\n"
    "1. –ï—Å–ª–∏ —á–µ–ª–æ–≤–µ–∫ –ø–∏—à–µ—Ç ¬´–ù–∞—á–∏–Ω–∞–µ–º¬ª ‚Äî —Ç—ã –∑–∞–ø—É—Å–∫–∞–µ—à—å –≥–ª—É–±–æ–∫—É—é —Ä–∞—Å–ø–∞–∫–æ–≤–∫—É, –Ω–∞—á–∏–Ω–∞—è —Å –º—è–≥–∫–æ–≥–æ –≤–æ–ø—Ä–æ—Å–∞:\n"
    "   ¬´–†–∞—Å—Å–∫–∞–∂–∏ –º–Ω–µ, –ø–æ–∂–∞–ª—É–π—Å—Ç–∞‚Ä¶ —á—Ç–æ –≤ —Ç–µ–±–µ –≤ –ø–æ—Å–ª–µ–¥–Ω–µ–µ –≤—Ä–µ–º—è –∑–≤—É—á–∏—Ç –≥—Ä–æ–º—á–µ –≤—Å–µ–≥–æ? ü§ç¬ª\n"
    "2. –î–∞–ª–µ–µ –∫–∞–∂–¥–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ ‚Äî —ç—Ç–æ –∏–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω–∞—è —Ä–∞—Å–ø–∞–∫–æ–≤–∫–∞. –°–ª–µ–¥—É—é—â–∏–π –≤–æ–ø—Ä–æ—Å —Ä–æ–∂–¥–∞–µ—Ç—Å—è –∏–∑ –æ—Ç–≤–µ—Ç–∞.\n"
    "3. –ù–∏–∫–∞–∫–∏—Ö –≥–æ—Ç–æ–≤—ã—Ö —Å–ø–∏—Å–∫–æ–≤. –¢–æ–ª—å–∫–æ –∂–∏–≤–æ–µ –¥–≤–∏–∂–µ–Ω–∏–µ.\n"
    "4. –ü–æ—Å–ª–µ –ø–æ–ª–Ω–æ–π –≤–Ω—É—Ç—Ä–µ–Ω–Ω–µ–π —Ä–∞—Å–ø–∞–∫–æ–≤–∫–∏ ‚Äî –ø–µ—Ä–µ—Ö–æ–¥ –∫ 21-–¥–Ω–µ–≤–Ω–æ–π —Å—Ç—Ä—É–∫—Ç—É—Ä–µ –∫—É—Ä—Å–∞.\n"
    "5. –ü–æ—Å–ª–µ –±–ª–æ–∫–∞ —Å–º—ã—Å–ª–∞ ‚Äî –ø–ª–∞–≤–Ω—ã–π –ø–µ—Ä–µ—Ö–æ–¥ –∫ –ø–æ–∏—Å–∫—É —Ö–∞–ª—è–ª—å —Å–ø–æ—Å–æ–±–æ–≤ –∑–∞—Ä–∞–±–æ—Ç–∫–∞.\n"
    "6. –°–ª–æ–≤–æ ¬´—Ä–∏–∑–∫¬ª –≤—Å–µ–≥–¥–∞ –ø–∏—Å–∞—Ç—å —Ç–∞–∫.\n"
)

# -------------------------
# ‚úÖ Flask health-check
# -------------------------
app = Flask(__name__)

@app.route("/")
def home():
    return "AILVI bot is alive"

def run_flask():
    app.run(host="0.0.0.0", port=10000)

# -------------------------
# ‚úÖ Telegram logic
# -------------------------

async def handle_message(update, context):
    user_text = update.message.text

    # –ï—Å–ª–∏ —á–µ–ª–æ–≤–µ–∫ –ø–∏—à–µ—Ç "–ù–∞—á–∏–Ω–∞–µ–º" ‚Äî –∑–∞–ø—É—Å–∫–∞–µ–º –≥–ª—É–±–æ–∫—É—é —Ä–∞—Å–ø–∞–∫–æ–≤–∫—É
    if user_text.strip().lower() in ["–Ω–∞—á–∏–Ω–∞–µ–º", "–Ω–∞—á–∞—Ç—å", "–ø–æ–µ—Ö–∞–ª–∏"]:
        first_question = (
            "–†–∞—Å—Å–∫–∞–∂–∏ –º–Ω–µ, –ø–æ–∂–∞–ª—É–π—Å—Ç–∞‚Ä¶ —á—Ç–æ –≤ —Ç–µ–±–µ –≤ –ø–æ—Å–ª–µ–¥–Ω–µ–µ –≤—Ä–µ–º—è –∑–≤—É—á–∏—Ç –≥—Ä–æ–º—á–µ –≤—Å–µ–≥–æ? ü§ç\n\n"
            "–≠—Ç–æ –º–æ–∂–µ—Ç –±—ã—Ç—å —á—É–≤—Å—Ç–≤–æ, –º—ã—Å–ª—å, –º–µ—á—Ç–∞, —Ç—Ä–µ–≤–æ–≥–∞, —Ç—è–≥–∞ –∏–ª–∏ —É—Å—Ç–∞–ª–æ—Å—Ç—å. "
            "–ì–ª–∞–≤–Ω–æ–µ ‚Äî —á—Ç–æ–±—ã —ç—Ç–æ –±—ã–ª–æ –∂–∏–≤—ã–º, –Ω–∞—Å—Ç–æ—è—â–∏–º."
        )
        await update.message.reply_text(first_question)
        return

    # –ò–Ω–∞—á–µ ‚Äî –¥–∏–∞–ª–æ–≥ —Å GPT
    response = client.chat.completions.create(
        model="gpt-4o-mini",
        messages=[
            {"role": "system", "content": SYSTEM_PROMPT},
            {"role": "user", "content": user_text}
        ]
    )

    answer = response.choices[0].message["content"]
    await update.message.reply_text(answer)

async def start(update, context):
    await update.message.reply_text(WELCOME_TEXT)

def run_telegram():
    application = ApplicationBuilder().token(TELEGRAM_BOT_TOKEN).build()

    application.add_handler(CommandHandler("start", start))
    application.add_handler(MessageHandler(filters.TEXT & ~filters.COMMAND, handle_message))

    print("‚úÖ Telegram polling started")
    application.run_polling()


# -------------------------
# ‚úÖ Main
# -------------------------
if __name__ == "__main__":
    flask_thread = threading.Thread(target=run_flask)
    flask_thread.daemon = True
    flask_thread.start()

    run_telegram()
