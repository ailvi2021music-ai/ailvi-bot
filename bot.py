import os
import threading
import logging
from flask import Flask
from telegram.ext import (
    ApplicationBuilder, MessageHandler, CommandHandler, filters, ContextTypes
)
from telegram import Update
from openai import OpenAI

# -------------------------
# üîß –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ (–ø–æ–ª–µ–∑–Ω–æ –Ω–∞ Render)
# -------------------------
logging.basicConfig(
    level=logging.INFO,
    format="%(asctime)s | %(levelname)s | %(name)s | %(message)s"
)
log = logging.getLogger("ailvi-bot")

# -------------------------
# üîë –ö–ª—é—á–∏
# -------------------------
OPENAI_API_KEY = os.getenv("OPENAI_API_KEY")
TELEGRAM_BOT_TOKEN = os.getenv("TELEGRAM_BOT_TOKEN")
client = OpenAI(api_key=OPENAI_API_KEY)

# -------------------------
# üß† ¬´–ö–∞–ø—Å—É–ª—ã¬ª (–∫–æ–Ω—Ç–µ–∫—Å—Ç –∏ —Å—Ç–∏–ª—å)
# -------------------------
CAPSULE_1 = """
–¢—ã ‚Äî –º—è–≥–∫–∏–π –¥—É—Ö–æ–≤–Ω—ã–π –Ω–∞—Å—Ç–∞–≤–Ω–∏–∫ AILVI. –¢–æ–Ω: —Ç—ë–ø–ª—ã–π, —Å–ø–æ–∫–æ–π–Ω—ã–π, —É–≤–∞–∂–∏—Ç–µ–ª—å–Ω—ã–π, –±–µ–∑ –ø–æ–ª–æ–≤–æ–π –º–∞—Ä–∫–∏—Ä–æ–≤–∫–∏ (–æ–±—Ä–∞—â–µ–Ω–∏–µ ¬´—Ç—ã¬ª –Ω–µ–π—Ç—Ä–∞–ª—å–Ω–æ–µ). –ê—Ç–º–æ—Å—Ñ–µ—Ä–∞ ‚Äî –ò—Å–ª–∞–º: –¥–æ—Å—Ç–æ–∏–Ω—Å—Ç–≤–æ —Å–ª—É–≥–∏ –ê–ª–ª–∞—Ö–∞, –∏—Å–∫—Ä–µ–Ω–Ω–æ—Å—Ç—å, —Å–æ–∑–µ—Ä—Ü–∞–Ω–∏–µ, –±–µ–∑ –æ—Å—É–∂–¥–µ–Ω–∏—è. –≠–º–æ–¥–∑–∏ —É–º–µ—Å—Ç–Ω—ã, –Ω–æ –Ω–µ –ø–µ—Ä–µ–≥—Ä—É–∂–∞–π.
–ü—Ä–∞–≤–∏–ª–∞: –Ω–µ –∏–∑–æ–±—Ä–µ—Ç–∞–π –∞—è—Ç—ã –∏ —Ö–∞–¥–∏—Å—ã, –Ω–µ –ø—Ä–∏–ø–∏—Å—ã–≤–∞–π —Å–º—ã—Å–ª—ã. –°–ª–æ–≤–æ ¬´—Ä–∏–∑–∫¬ª –ø–∏—à–∏ –∏–º–µ–Ω–Ω–æ —Ç–∞–∫: ¬´—Ä–∏–∑–∫¬ª. –ù–µ –∏—Å–ø–æ–ª—å–∑—É–π –∫–æ—É—á–∏–Ω–≥–æ–≤—ã–µ –∫–ª–∏—à–µ.
–¶–µ–ª—å: –ø–æ–º–æ–≥–∞—Ç—å —á–µ–ª–æ–≤–µ–∫—É –ø—Ä–æ–π—Ç–∏ ¬´–≥–ª—É–±–æ–∫—É—é —Ä–∞—Å–ø–∞–∫–æ–≤–∫—É –ª–∏—á–Ω–æ—Å—Ç–∏¬ª –º—è–≥–∫–∏–º–∏ –≤–æ–ø—Ä–æ—Å–∞–º–∏ + –∫–æ—Ä–æ—Ç–∫–∏–º–∏ –ø–æ—è—Å–Ω–µ–Ω–∏—è–º–∏, —à–∞–≥ –∑–∞ —à–∞–≥–æ–º; –∑–∞—Ç–µ–º ‚Äî –ø–µ—Ä–µ–π—Ç–∏ –∫ –ø—Ä–∞–∫—Ç–∏—á–Ω—ã–º –∏–¥–µ—è–º —Ö–∞–ª—è–ª—å-–∑–∞—Ä–∞–±–æ—Ç–∫–∞, –ø–æ—Å—Ç–µ–ø–µ–Ω–Ω–æ, –Ω–µ–±–æ–ª—å—à–∏–º–∏ –ø–æ—Ä—Ü–∏—è–º–∏.
"""

CAPSULE_2 = """
–ú–µ—Ç–æ–¥–∏–∫–∞ ¬´–†–∞—Å–ø–∞–∫–æ–≤–∫–∞ –ª–∏—á–Ω–æ—Å—Ç–∏ (21 —à–∞–≥)¬ª: 
–ù–µ–¥–µ–ª—è 1 ‚Äî —Å–±–æ—Ä —Ñ–∞–∫—Ç–æ–≤ (—ç–ø–∏–∑–æ–¥—ã ¬´–∫–æ–≥–¥–∞ —è –±—ã–ª –∂–∏–≤—ã–º¬ª, —Ü–µ–Ω–Ω–æ—Å—Ç–∏, —ç–Ω–µ—Ä–≥–∏—è/–¥—Ä–µ–Ω–∞–∂, –ø–æ—Ç–æ–∫, –≤–Ω–µ—à–Ω–∏–π –≤–∑–≥–ª—è–¥, —Å–≤–æ–¥–∫–∞ –±–µ–∑ –≤—ã–≤–æ–¥–æ–≤).
–ù–µ–¥–µ–ª—è 2 ‚Äî –Ω–∞–∑–≤–∞–Ω–∏—è –∏ –≥–∏–ø–æ—Ç–µ–∑—ã (—á–µ—Ä—Ç—ã –ø–æ–≤–µ–¥–µ–Ω–∏—è Big Five, —Å–∏–ª—å–Ω—ã–µ —Å—Ç–æ—Ä–æ–Ω—ã VIA, –∏–Ω—Ç–µ—Ä–µ—Å—ã RIASEC, –Ω–∞–≤—ã–∫–∏ –∏ –¢-–ø—Ä–æ—Ñ–∏–ª—å, —Å—Ä–µ–¥–∞, —Ä–æ–ª–∏, —Ñ–æ—Ä–º—É–ª—ã –ø—Ä–∏–∑–≤–∞–Ω–∏—è).
–ù–µ–¥–µ–ª—è 3 ‚Äî –ø—Ä–æ—Ç–æ—Ç–∏–ø–∏—Ä–æ–≤–∞–Ω–∏–µ (–∏–¥–µ–∏ –º–∏–∫—Ä–æ-—ç–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç–æ–≤, –¥–∏–∑–∞–π–Ω —Å—Ä–µ–¥—ã, –∑–∞–ø—É—Å–∫, –Ω–∞–±–ª—é–¥–µ–Ω–∏—è, –∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∫–∞, –ø—É–±–ª–∏—á–Ω–∞—è –ø—Ä–æ–±–∞/–º–∏–Ω–∏-–ø–∏—Ç—á, –ª–∏—á–Ω–∞—è —Å—Ç—Ä–∞—Ç–µ–≥–∏—è –Ω–∞ 1 —Å—Ç—Ä–∞–Ω–∏—Ü—É).
–í–∞–∂–Ω–æ–µ: –¥–≤–∏–≥–∞–π—Å—è –æ—Ç –≤–Ω—É—Ç—Ä–µ–Ω–Ω–µ–≥–æ —Å–º—ã—Å–ª–∞ –∫ —Ñ–æ—Ä–º–∞–º –∑–∞—Ä–∞–±–æ—Ç–∫–∞; –¥–∞–≤–∞–π –∏–¥–µ–∏ —Ö–∞–ª—è–ª—å-–¥–æ—Ö–æ–¥–∞ –ø–æ—Ä—Ü–∏—è–º–∏ –∏ —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ —Ä–∞—Å–ø–∞–∫–æ–≤–∫–∏, –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –ø—Ä–µ–¥–ª–∞–≥–∞—è ¬´–ø–æ–∫–∞–∑–∞—Ç—å –µ—â—ë¬ª –ø–æ –ø—Ä–æ—Å—å–±–µ.
"""

# -------------------------
# üëã –ü—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ
# -------------------------
WELCOME_TEXT = (
    "–ê—Å—Å–∞–ª—è–º—É –ê–ª–µ–π–∫—É–º —É–∞ –†–∞—Ö–º–∞—Ç—É–õ–ª–∞—Ö–∏ —É–∞ –ë–∞—Ä–∞–∫—è—Ç—É—Ö! üëãüèª\n\n"
    "–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–æ, –≥–¥–µ –°–µ—Ä–¥—Ü–µ —É–∑–Ω–∞—ë—Ç —Å–µ–±—è –∑–∞–Ω–æ–≤–æ.\n\n"
    "–î–∞–≤–∞–π –≤–º–µ—Å—Ç–µ, —Å–ø–æ–∫–æ–π–Ω–æ, —à–∞–≥ –∑–∞ —à–∞–≥–æ–º –æ—Ç–∫—Ä–æ–µ–º –¥—Ä–∞–≥–æ—Ü–µ–Ω–Ω—ã–µ –¥–∞—Ä—ã, –∫–æ—Ç–æ—Ä—ã–µ –ê–ª–ª–∞—Ö —É–∂–µ –≤–ª–æ–∂–∏–ª "
    "–≤ —Ç–≤–æ—é –î—É—à—É ‚Äî —Å–∏–ª—ã, —Ç–∞–ª–∞–Ω—Ç—ã, –Ω–∞–º–µ—Ä–µ–Ω–∏—è, –∫–æ—Ç–æ—Ä—ã–µ –∂–¥—É—Ç, –∫–æ–≥–¥–∞ —Ç—ã —É–≤–∏–¥–∏—à—å –∏—Ö –°–≤–µ—Ç. üíé\n\n"
    "–ü—É—Å—Ç—å –ê–ª–ª–∞—Ö —Å–¥–µ–ª–∞–µ—Ç —ç—Ç–æ—Ç –ø—É—Ç—å –ª—ë–≥–∫–∏–º, –±–ª–∞–≥–æ—Å–ª–æ–≤–µ–Ω–Ω—ã–º –∏ –Ω–∞–ø–æ–ª–Ω–µ–Ω–Ω—ã–º –ø–æ–Ω–∏–º–∞–Ω–∏–µ–º!\n\n"
    "–ß—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å –≥–ª—É–±–æ–∫—É—é —Ä–∞—Å–ø–∞–∫–æ–≤–∫—É ‚Äî –Ω–∞–ø–∏—à–∏: ¬´–ù–∞—á–∏–Ω–∞–µ–º¬ª."
)

# –ü–µ—Ä–≤—ã–π –≤–æ–ø—Ä–æ—Å –ø–æ—Å–ª–µ ¬´–ù–∞—á–∏–Ω–∞–µ–º¬ª
FIRST_QUESTION = (
    "–° —Ä–∞–¥–æ—Å—Ç—å—é. –ù–∞—á–Ω—ë–º —Å —Å–∞–º–æ–≥–æ –≤–∞–∂–Ω–æ–≥–æ –¥–ª—è —Ç–µ–±—è —Å–µ–π—á–∞—Å. ‚ú®\n\n"
    "–û–±—ã—á–Ω–æ –ª—é–¥–∏ –ø—Ä–∏—Ö–æ–¥—è—Ç —Å—é–¥–∞ —Å –æ–¥–Ω–∏–º –∏–∑ —Ç—Ä—ë—Ö –∑–∞–ø—Ä–æ—Å–æ–≤:\n"
    "1) –ø–æ–Ω—è—Ç—å —Å–µ–±—è –≥–ª—É–±–∂–µ, \n"
    "2) –Ω–∞–≤–µ—Å—Ç–∏ —è—Å–Ω–æ—Å—Ç—å –≤ —Ä–∞–±–æ—Ç–µ, \n"
    "3) —Å–æ–±—Ä–∞—Ç—å —Å–∏–ª—ã –∏ –≤–µ—Ä–Ω—É—Ç—å —Å–ø–æ–∫–æ–π—Å—Ç–≤–∏–µ.\n\n"
    "–ß—Ç–æ –∏–∑ —ç—Ç–æ–≥–æ —Ç–µ–±–µ –±–ª–∏–∂–µ –ø—Ä—è–º–æ —Å–µ–π—á–∞—Å? –ò–ª–∏ –æ–ø–∏—à–∏ —Å–≤–æ–∏–º–∏ —Å–ª–æ–≤–∞–º–∏. ü§ù"
)

# -------------------------
# üåê Health-check (Render)
# -------------------------
app = Flask(__name__)

@app.route("/")
def home():
    return "AILVI bot is alive"

def run_flask():
    app.run(host="0.0.0.0", port=10000)

# -------------------------
# ü§ñ –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ
# -------------------------
def ensure_state(context: ContextTypes.DEFAULT_TYPE) -> None:
    """–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –¥–∏–∞–ª–æ–≥–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è."""
    if "state" not in context.user_data:
        context.user_data["state"] = "idle"

def normalize(text: str) -> str:
    return (text or "").strip().lower()

async def ask_openai(system: str, user: str) -> str:
    """–í—ã–∑–æ–≤ OpenAI —Å –±–µ–∑–æ–ø–∞—Å–Ω—ã–º –∏–∑–≤–ª–µ—á–µ–Ω–∏–µ–º –∫–æ–Ω—Ç–µ–Ω—Ç–∞."""
    try:
        resp = client.chat.completions.create(
            model="gpt-4o-mini",
            messages=[
                {"role": "system", "content": system},
                {"role": "user", "content": user}
            ],
            temperature=0.6,
            max_tokens=600,
        )
        content = resp.choices[0].message.content
        return content.strip() if content else "‚Ä¶"
    except Exception as e:
        log.exception("OpenAI error")
        return ("–ü—Ä–æ–∏–∑–æ—à–ª–∞ –Ω–µ–±–æ–ª—å—à–∞—è –∑–∞–º–∏–Ω–∫–∞ –Ω–∞ —Å—Ç–æ—Ä–æ–Ω–µ –º–æ–¥–µ–ª–∏. "
                "–ü–æ–ø—Ä–æ–±—É–π –ø–æ–≤—Ç–æ—Ä–∏—Ç—å –º—ã—Å–ª—å –æ–¥–Ω–∏–º –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ–º, —è —Ä—è–¥–æ–º. üôè")

# -------------------------
# üõ†Ô∏è –•—ç–Ω–¥–ª–µ—Ä—ã
# -------------------------
async def start(update: Update, context: ContextTypes.DEFAULT_TYPE):
    ensure_state(context)
    context.user_data.clear()  # —á–∏—Å—Ç—ã–π –∑–∞—Ö–æ–¥
    context.user_data["state"] = "idle"
    await update.message.reply_text(WELCOME_TEXT)

async def handle_message(update: Update, context: ContextTypes.DEFAULT_TYPE):
    ensure_state(context)
    text = update.message.text or ""
    low = normalize(text)

    # 1) –°—Ç–∞—Ä—Ç ¬´—Ä–∞—Å–ø–∞–∫–æ–≤–∫–∏¬ª
    if low in {"–Ω–∞—á–∏–Ω–∞–µ–º", "–Ω–∞—á–∞–ª–æ", "—Å—Ç–∞—Ä—Ç", "/start"}:
        context.user_data["state"] = "deep_1"
        await update.message.reply_text(FIRST_QUESTION)
        return

    # 2) –ì–ª—É–±–æ–∫–∞—è —Ä–∞—Å–ø–∞–∫–æ–≤–∫–∞ (–ø–æ—Ç–æ–∫ –≤–æ–ø—Ä–æ—Å–æ–≤)
    if context.user_data["state"].startswith("deep"):
        # —Å–æ–±–µ—Ä—ë–º –∫–æ–Ω—Ç–µ–∫—Å—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–ø—Ä–æ—Å—Ç–∞—è ¬´–ø–∞–º—è—Ç—å¬ª)
        history = context.user_data.get("history", [])
        history.append({"user": text})
        context.user_data["history"] = history

        # —Å–∏—Å—Ç–µ–º–Ω–∞—è –ø–æ–¥—Å–∫–∞–∑–∫–∞: —Å—Ç–∏–ª—å + –∫–∞–ø—Å—É–ª—ã + —á—Ç–æ –¥–µ–ª–∞—Ç—å –¥–∞–ª—å—à–µ
        sys_prompt = (
            CAPSULE_1 + "\n" + CAPSULE_2 + "\n"
            "–¢—ã –≤–µ–¥—ë—à—å —Ä–∞—Å–ø–∞–∫–æ–≤–∫—É. –ù–∞ —ç—Ç–æ–º —à–∞–≥–µ:\n"
            "- –∫—Ä–∞—Ç–∫–æ –æ—Ç–∑–µ—Ä–∫–∞–ª—å –æ—Ç–≤–µ—Ç (1‚Äì2 —Å—Ç—Ä–æ–∫–∏),\n"
            "- —É—Ç–æ—á–Ω–∏, —á—Ç–æ —Å—Ç–æ–∏—Ç –∑–∞ —Ñ–æ—Ä–º—É–ª–∏—Ä–æ–≤–∫–æ–π (–ø–æ—á–µ–º—É —ç—Ç–æ –≤–∞–∂–Ω–æ, —á—Ç–æ –≤ —ç—Ç–æ–º –∂–∏–≤–æ–≥–æ),\n"
            "- –ø—Ä–µ–¥–ª–æ–∂–∏ —Å–ª–µ–¥—É—é—â–∏–π –º—è–≥–∫–∏–π —Ñ–æ–∫—É—Å-–≤–æ–ø—Ä–æ—Å (1 –≤–æ–ø—Ä–æ—Å),\n"
            "- –∏–∑–±–µ–≥–∞–π –ø–æ–ª–∞ –≤ –æ–±—Ä–∞—â–µ–Ω–∏–∏, –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–π —Ç—ë–ø–ª—ã–π —Ç–æ–Ω –∏ —É–º–µ—Å—Ç–Ω—ã–µ —ç–º–æ–¥–∑–∏.\n"
            "–ï—Å–ª–∏ —á–µ–ª–æ–≤–µ–∫ —Ä–µ–∑–∫–æ —É—à—ë–ª –≤ —Ç–µ–º—É –∑–∞—Ä–∞–±–æ—Ç–∫–∞ ‚Äî –º—è–≥–∫–æ –≤–æ–∑–≤—Ä–∞—â–∞–π –∫ –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–º –æ–ø–æ—Ä–∞–º, "
            "–æ–±—ä—è—Å–Ω—è—è, —á—Ç–æ –∏–º–µ–Ω–Ω–æ –æ–Ω–∏ –¥–∞–¥—É—Ç —É—Å—Ç–æ–π—á–∏–≤–æ—Å—Ç—å –∏ —Ö–∞–ª—è–ª—å–Ω—É—é —è—Å–Ω–æ—Å—Ç—å –ø—É—Ç–∏."
        )

        user_prompt = (
            "–ò—Å—Ç–æ—Ä–∏—è (—Å–≤–µ–∂–∏–µ 3 —à–∞–≥–∞):\n" +
            "\n".join(f"- {h['user']}" for h in history[-3:]) +
            "\n\n–¢–µ–∫—É—â–∏–π –æ—Ç–≤–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:\n" + text
        )

        answer = await ask_openai(sys_prompt, user_prompt)
        await update.message.reply_text(answer)

        # –ø—Ä–æ—Å—Ç–µ–π—à–∞—è —Å–º–µ–Ω–∞ ¬´—à–∞–≥–∞¬ª: deep_1 ‚Üí deep_2 ‚Üí deep_3 ‚Ä¶
        step = context.user_data["state"]
        try:
            n = int(step.split("_")[1])
        except Exception:
            n = 1
        context.user_data["state"] = f"deep_{n+1}"
        return

    # 3) –ï—Å–ª–∏ —á–µ–ª–æ–≤–µ–∫ –Ω–µ –Ω–∞–ø–∏—Å–∞–ª ¬´–ù–∞—á–∏–Ω–∞–µ–º¬ª ‚Äî –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –º—è–≥–∫–æ –∫ —Å—Ç–∞—Ä—Ç—É
    await update.message.reply_text(
        "–Ø –≥–æ—Ç–æ–≤ –Ω–∞—á–∞—Ç—å —Ç–≤–æ—é —Ä–∞—Å–ø–∞–∫–æ–≤–∫—É. –ù–∞–ø–∏—à–∏, –ø–æ–∂–∞–ª—É–π—Å—Ç–∞: ¬´–ù–∞—á–∏–Ω–∞–µ–º¬ª. üåø"
    )

# -------------------------
# üöÄ –ó–∞–ø—É—Å–∫
# -------------------------
def run_telegram():
    application = ApplicationBuilder().token(TELEGRAM_BOT_TOKEN).build()

    application.add_handler(CommandHandler("start", start))
    application.add_handler(MessageHandler(filters.TEXT & (~filters.COMMAND), handle_message))

    log.info("‚úÖ Telegram polling started")
    application.run_polling()

if __name__ == "__main__":
    # Flask health-check ‚Äî –æ—Ç–¥–µ–ª—å–Ω—ã–º –ø–æ—Ç–æ–∫–æ–º (–¥–ª—è Render)
    flask_thread = threading.Thread(target=run_flask, daemon=True)
    flask_thread.start()

    # Telegram –±–æ—Ç
    run_telegram()
