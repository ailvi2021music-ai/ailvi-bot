import os
import re
import logging
from typing import Optional

from telegram import Update
from telegram.constants import ParseMode
from telegram.ext import (
    ApplicationBuilder,
    ContextTypes,
    MessageHandler,
    CommandHandler,
    filters,
)

# ---------------------- –õ–û–ì–ò ----------------------
logging.basicConfig(
    format="%(asctime)s | %(levelname)s | %(name)s | %(message)s",
    level=logging.INFO,
)
log = logging.getLogger("ailvi-bot")

# ---------------------- –ù–ê–°–¢–†–û–ô–ö–ò ----------------------
TOKEN = os.getenv("TELEGRAM_BOT_TOKEN", "").strip()
MODE = os.getenv("MODE", "polling").strip().lower()  # polling | webhook (–º—ã –∏—Å–ø–æ–ª—å–∑—É–µ–º polling)

if not TOKEN:
    raise RuntimeError("TELEGRAM_BOT_TOKEN –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –≤ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è.")

# ---------------------- –¢–ï–ö–°–¢–´ (HTML) ----------------------
WELCOME_TEXT = (
    "<b>–ê—Å—Å–∞–ª—è–º—É –ê–ª–µ–π–∫—É–º —É–∞ –†–∞—Ö–º–∞—Ç—É–õ–ª–∞—Ö–∏ —É–∞ –ë–∞—Ä–∞–∫—è—Ç—É—Ö!</b> üëãüèª\n\n"
    "–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–æ, –≥–¥–µ <b>–°–µ—Ä–¥—Ü–µ</b> —É–∑–Ω–∞—ë—Ç —Å–µ–±—è –∑–∞–Ω–æ–≤–æ.\n\n"
    "–ü–æ–π–¥—ë–º –º—è–≥–∫–æ, —à–∞–≥ –∑–∞ —à–∞–≥–æ–º, —á—Ç–æ–±—ã –æ—Ç–∫—Ä—ã—Ç—å –¥–∞—Ä—ã, –∫–æ—Ç–æ—Ä—ã–µ –ê–ª–ª–∞—Ö —É–∂–µ –≤–ª–æ–∂–∏–ª "
    "–≤ —Ç–≤–æ—é –¥—É—à—É ‚Äî —Å–∏–ª—ã, —Ç–∞–ª–∞–Ω—Ç—ã –∏ –Ω–∞–º–µ—Ä–µ–Ω–∏—è, –∫–æ—Ç–æ—Ä—ã–µ –∂–¥—É—Ç, –∫–æ–≥–¥–∞ —Ç—ã —É–≤–∏–¥–∏—à—å –∏—Ö —Å–≤–µ—Ç. üíé\n\n"
    "–ü—É—Å—Ç—å –ê–ª–ª–∞—Ö —Å–¥–µ–ª–∞–µ—Ç —ç—Ç–æ—Ç –ø—É—Ç—å –ª—ë–≥–∫–∏–º, –±–ª–∞–≥–æ—Å–ª–æ–≤–µ–Ω–Ω—ã–º –∏ –Ω–∞–ø–æ–ª–Ω–µ–Ω–Ω—ã–º –ø–æ–Ω–∏–º–∞–Ω–∏–µ–º!\n\n"
    "–ß—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å –≥–ª—É–±–æ–∫—É—é —Ä–∞—Å–ø–∞–∫–æ–≤–∫—É ‚Äî –Ω–∞–ø–∏—à–∏: <b>–ù–∞—á–∏–Ω–∞–µ–º</b> ‚ú®"
)

FIRST_DEEP_PROMPT = (
    "–ù–∞—á–Ω—ë–º —Å —Å–∞–º–æ–≥–æ –≤–∞–∂–Ω–æ–≥–æ –¥–ª—è —Ç–µ–±—è —Å–µ–π—á–∞—Å. ‚ú®\n\n"
    "–°–∫–∞–∂–∏ –∫–æ—Ä–æ—Ç–∫–æ, –∫–∞–∫–∞—è –æ–±–ª–∞—Å—Ç—å –∑–æ–≤—ë—Ç —Å–∏–ª—å–Ω–µ–µ –≤—Å–µ–≥–æ —Å–µ–≥–æ–¥–Ω—è:\n"
    "‚Äî <i>—Å–º—ã—Å–ª/–ø—Ä–∏–∑–≤–∞–Ω–∏–µ</i>,\n"
    "‚Äî <i>–≤–Ω—É—Ç—Ä–µ–Ω–Ω–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ</i>,\n"
    "‚Äî <i>–æ—Ç–Ω–æ—à–µ–Ω–∏—è —Å —Ä–∞–±–æ—Ç–æ–π/–¥–µ–ª–æ–º</i>,\n"
    "‚Äî <i>—è—Å–Ω–æ—Å—Ç—å –≤ —à–∞–≥–∞—Ö</i>.\n\n"
    "–ù–∞–ø–∏—à–∏ –æ–¥–Ω–∏–º —Å–ª–æ–≤–æ–º –∏–ª–∏ —Ñ—Ä–∞–∑–æ–π (–Ω–∞–ø—Ä–∏–º–µ—Ä: ¬´–ø—Ä–∏–∑–≤–∞–Ω–∏–µ¬ª, ¬´—è—Å–Ω–æ—Å—Ç—å –≤ —à–∞–≥–∞—Ö¬ª)."
)

# ¬´–ú–æ—Å—Ç¬ª –µ—Å–ª–∏ —á–µ–ª–æ–≤–µ–∫ —Å—Ä–∞–∑—É –ø–∏—à–µ—Ç ¬´—Ä–∞–±–æ—Ç–∞¬ª
BRIDGE_TO_DEPTH = (
    "–ü–æ–Ω–∏–º–∞—é, —Ç–µ–º–∞ —Ä–∞–±–æ—Ç—ã –≤–∞–∂–Ω–∞. –ò —á—Ç–æ–±—ã —Ä–µ—à–µ–Ω–∏–µ –±—ã–ª–æ <b>–∂–∏–≤—ã–º –∏ —É—Å—Ç–æ–π—á–∏–≤—ã–º</b>, "
    "–ø—Ä–æ–π–¥—ë–º –∫–æ—Ä–æ—Ç–∫—É—é –≤–Ω—É—Ç—Ä–µ–Ω–Ω—é—é –Ω–∞—Å—Ç—Ä–æ–π–∫—É:\n\n"
    "1) –ß—Ç–æ –∏–∑ —Ç–æ–≥–æ, —á—Ç–æ —Ç—ã –¥–µ–ª–∞–ª(–∞) –∫–æ–≥–¥–∞-–ª–∏–±–æ, –ø—Ä–∏–Ω–æ—Å–∏–ª–æ <b>—Ç–∏—Ö—É—é —Ä–∞–¥–æ—Å—Ç—å</b>? ‚ú®\n"
    "2) –í –∫–∞–∫–∏—Ö –º–æ–º–µ–Ω—Ç–∞—Ö —Ç—ã —á—É–≤—Å—Ç–≤–æ–≤–∞–ª(–∞): ¬´<i>—ç—Ç–æ –ø–æ-–Ω–∞—Å—Ç–æ—è—â–µ–º—É –º–æ—ë</i>¬ª?\n"
    "3) –ö–∞–∫–∞—è –ø–æ–ª—å–∑–∞ –¥–ª—è –ª—é–¥–µ–π –æ—Ç–∫–ª–∏–∫–∞–µ—Ç—Å—è —Å–µ—Ä–¥—Ü—É ‚Äî <i>–∫–∞–∫–æ–º—É —á–µ–ª–æ–≤–µ–∫—É —Ç—ã —Ö–æ—á–µ—à—å –ø–æ–º–æ—á—å –∏ –≤ —á—ë–º</i>?\n\n"
    "–û—Ç–≤–µ—Ç—å –∫–æ—Ä–æ—Ç–∫–æ. –ò–∑ —ç—Ç–æ–≥–æ —Å–ª–æ–∂–∏–º –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∏ –ø–µ—Ä–≤—ã–µ —à–∞–≥–∏. üåø"
)

# –°–ª–µ–¥—É—é—â–∞—è –ø–æ–¥—Å–∫–∞–∑–∫–∞ –ø–æ—Å–ª–µ –ø–µ—Ä–≤–æ–≥–æ ¬´—è –Ω–µ –∑–Ω–∞—é¬ª
GENTLE_PROGRESS = (
    "–≠—Ç–æ –Ω–æ—Ä–º–∞–ª—å–Ω–æ ‚Äî –±—ã—Ç—å –≤ –ø–æ–∏—Å–∫–µ. –î–∞–≤–∞–π –ø–æ–º–æ–∂–µ–º —Å–µ—Ä–¥—Ü—É –∑–∞–≥–æ–≤–æ—Ä–∏—Ç—å:\n\n"
    "‚Äî –ù–∞–∑–æ–≤–∏ 2‚Äì3 –∑–∞–Ω—è—Ç–∏—è, –≥–¥–µ —Ç—ã –∑–∞–±—ã–≤–∞–µ—à—å –æ –≤—Ä–µ–º–µ–Ω–∏.\n"
    "‚Äî –ß—Ç–æ —Ç–µ–±—è <i>—É—Ç–æ–º–ª—è–µ—Ç</i> –±–æ–ª—å—à–µ –≤—Å–µ–≥–æ (—ç—Ç–æ –ø–æ–º–æ–∂–µ—Ç –ø–æ–Ω—è—Ç—å, —á–µ–≥–æ –Ω–µ –±—Ä–∞—Ç—å)?\n"
    "‚Äî –ö–∞–∫–∞—è –ø—Ä–æ—Å—Ç–∞—è –ø–æ–ª—å–∑–∞ –¥–ª—è –ª—é–¥–µ–π –≤–¥–æ—Ö–Ω–æ–≤–ª—è–µ—Ç (–±–µ–∑ –ø–∞—Ñ–æ—Å–∞ ‚Äî –ø–æ-–¥–æ–±—Ä–æ–º—É –∏ —Ä–µ–∞–ª—å–Ω–æ)?"
)

# –û—Ç–≤–µ—Ç, –µ—Å–ª–∏ —Å–ø—Ä–∞—à–∏–≤–∞—é—Ç ¬´–∫—Ç–æ —Ç—ã? ChatGPT? OpenAI?¬ª
IDENTITY_DEFLECT = (
    "–Ø ‚Äî —Ç–≤–æ–π –±–µ—Ä–µ–∂–Ω—ã–π –ø—Ä–æ–≤–æ–¥–Ω–∏–∫ –∏ –¥–∏–∞–ª–æ–≥–æ–≤—ã–π –ø–æ–º–æ—â–Ω–∏–∫ –≤–Ω—É—Ç—Ä–∏ –ø—Ä–æ–µ–∫—Ç–∞ AILVI. üåø\n"
    "–ú–æ—è –∑–∞–¥–∞—á–∞ ‚Äî –∞–∫–∫—É—Ä–∞—Ç–Ω–æ –Ω–∞–≤–æ–¥–∏—Ç—å —è—Å–Ω–æ—Å—Ç—å, –∑–∞–¥–∞–≤–∞—Ç—å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ –≤–æ–ø—Ä–æ—Å—ã –∏ –¥–µ—Ä–∂–∞—Ç—å –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ: "
    "–∏—Å–ª–∞–º—Å–∫–∏–µ –æ—Ä–∏–µ–Ω—Ç–∏—Ä—ã, –º—è–≥–∫–æ—Å—Ç—å, –ø–æ–ª—å–∑–∞ –∏ —à–∞–≥–∏ –∫ –¥–µ–ª—É."
)

# ---------------------- –•–ï–õ–ü–ï–†–´ ----------------------
INTENT_WORK_KEYWORDS = [
    "—Ä–∞–±–æ—Ç", "–∫–∞—Ä—å–µ—Ä", "–≤–∞–∫–∞–Ω", "–¥–µ–Ω—å–≥", "–¥–æ—Ö–æ–¥", "–ø—Ä–æ—Ñ–µ—Å", "–¥–µ–ª–æ", "–∑–∞—Ä–∞–±"
]

ASKS_IDENTITY = re.compile(r"(openai|gpt|chatgpt|—á–∞—Ç–≥–ø—Ç|–∫—Ç–æ —Ç—ã|—á—Ç–æ —Ç—ã|–∫–∞–∫–∞—è —Ç—ã –º–æ–¥–µ–ª—å)", re.I)

def mentions_work(text: str) -> bool:
    t = text.lower()
    return any(k in t for k in INTENT_WORK_KEYWORDS)

def is_unknown(text: str) -> bool:
    return text.strip().lower() in {"–Ω–µ –∑–Ω–∞—é", "–Ω–µ –∑–Ω–∞—é.", "–Ω–µ —É–≤–µ—Ä–µ–Ω", "–Ω–µ —É–≤–µ—Ä–µ–Ω–∞", "–Ω–µ –ø–æ–Ω–∏–º–∞—é"}

# ---------------------- HANDLERS ----------------------
async def cmd_start(update: Update, context: ContextTypes.DEFAULT_TYPE):
    context.user_data.clear()
    await update.message.reply_html(WELCOME_TEXT, disable_web_page_preview=True)

async def cmd_reset(update: Update, context: ContextTypes.DEFAULT_TYPE):
    context.user_data.clear()
    await update.message.reply_html("–ü–∞–º—è—Ç—å –¥–∏–∞–ª–æ–≥–∞ –æ—á–∏—â–µ–Ω–∞. –ú–æ–∂–µ–º –Ω–∞—á–∞—Ç—å –∑–∞–Ω–æ–≤–æ: –Ω–∞–ø–∏—à–∏ <b>–ù–∞—á–∏–Ω–∞–µ–º</b>.")

async def handle_text(update: Update, context: ContextTypes.DEFAULT_TYPE):
    text = (update.message.text or "").strip()

    # –∑–∞—â–∏—Ç–∞ –æ—Ç —Ä–∞—Å—Å–ø—Ä–æ—Å–æ–≤ –æ ¬´–∫—Ç–æ —Ç—ã / OpenAI¬ª
    if ASKS_IDENTITY.search(text):
        await update.message.reply_html(IDENTITY_DEFLECT)
        return

    # –∑–∞–ø—É—Å–∫ —Ä–∞—Å–ø–∞–∫–æ–≤–∫–∏
    if text.lower() == "–Ω–∞—á–∏–Ω–∞–µ–º":
        context.user_data["phase"] = "onboarding1"
        await update.message.reply_html(FIRST_DEEP_PROMPT)
        return

    # –µ—Å–ª–∏ —á–µ–ª–æ–≤–µ–∫ –µ—â—ë –Ω–µ –Ω–∞—á–∞–ª, –º—è–≥–∫–æ –ø–æ–¥—Å–∫–∞–∑–∞—Ç—å
    if "phase" not in context.user_data:
        await update.message.reply_html(
            "–ß—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å —Ä–∞—Å–ø–∞–∫–æ–≤–∫—É ‚Äî –Ω–∞–ø–∏—à–∏: <b>–ù–∞—á–∏–Ω–∞–µ–º</b> ‚ú®"
        )
        return

    # –µ—Å–ª–∏ –Ω–∞–ø–∏—Å–∞–ª–∏ ¬´—Ä–∞–±–æ—Ç–∞/–¥–µ–Ω—å–≥–∏¬ª ‚Äî –¥–µ–ª–∞–µ–º –º–æ—Å—Ç –∫ –≥–ª—É–±–∏–Ω–µ
    if mentions_work(text):
        context.user_data["phase"] = "work_bridge"
        await update.message.reply_html(BRIDGE_TO_DEPTH)
        return

    # ¬´–Ω–µ –∑–Ω–∞—é¬ª ‚Äî –º—è–≥–∫–∞—è –ø–æ–¥–¥–µ—Ä–∂–∫–∞, —Å–ª–µ–¥—É—é—â–∏–π —à–∞–≥
    if is_unknown(text):
        await update.message.reply_html(GENTLE_PROGRESS)
        return

    # –æ–±—â–∏–π ¬´–ø—Ä–æ–¥–æ–ª–∂–∞—Ç–µ–ª—å¬ª: —Å–æ—Ö—Ä–∞–Ω—è–µ–º –∫—Ä–∞—Ç–∫—É—é –ø–∞–º—è—Ç—å —Ö–æ–¥–∞ –∏ –¥–≤–∏–≥–∞–µ–º –¥–∞–ª—å—à–µ –≤–æ–ø—Ä–æ—Å–∞–º–∏
    history = context.user_data.setdefault("notes", [])
    if len(text) <= 800:
        history.append(text)

    # –ù–µ–±–æ–ª—å—à–æ–π —Ä–∏—Ç–º –≤–æ–ø—Ä–æ—Å–æ–≤ (–Ω–µ–π—Ç—Ä–∞–ª—å–Ω—ã–µ, –±–µ–∑ –ø–æ–ª–∞)
    followups = [
        "–û—Ç–º–µ—á—É. –ß—Ç–æ –∏–∑ —Å–∫–∞–∑–∞–Ω–Ω–æ–≥–æ –¥–ª—è —Ç–µ–±—è —Å–∞–º–æ–µ –∂–∏–≤–æ–µ <i>—Å–µ–π—á–∞—Å</i>?",
        "–ï—Å–ª–∏ —Å—É–∑–∏—Ç—å —Ñ–æ–∫—É—Å –¥–æ –æ–¥–Ω–æ–≥–æ —à–∞–≥–∞ –Ω–∞ 7 –¥–Ω–µ–π ‚Äî –∫–∞–∫–æ–π —à–∞–≥ –±—É–¥–µ—Ç —Å–∞–º—ã–º –¥–æ–±—Ä—ã–º –∏ —Ä–µ–∞–ª—å–Ω—ã–º? ‚úçÔ∏è",
        "–ü—Ä–µ–¥—Å—Ç–∞–≤—å —á–µ–ª–æ–≤–µ–∫–∞, –∫–æ—Ç–æ—Ä–æ–º—É —ç—Ç–æ –ø—Ä–∏–Ω–µ—Å—ë—Ç –ø–æ–ª—å–∑—É. –ö—Ç–æ –æ–Ω –∏ —á–µ–º —Ç—ã –º–æ–∂–µ—à—å –±—ã—Ç—å –µ–º—É –ø–æ–ª–µ–∑–µ–Ω(–Ω–∞)?",
        "–•–æ—á–µ—à—å, —è —Å–æ–±–µ—Ä—É –∏–∑ –æ—Ç–≤–µ—Ç–æ–≤ –∫–æ—Ä–æ—Ç–∫–∏–π –ø–µ—Ä–µ—á–µ–Ω—å —Ç–≤–æ–∏—Ö –æ–ø–æ—Ä –∏ —à–∞–≥–æ–≤?",
    ]

    i = context.user_data.setdefault("followup_idx", 0)
    msg = followups[i % len(followups)]
    context.user_data["followup_idx"] = i + 1

    await update.message.reply_html(msg)

# ---------------------- –°–ï–†–í–ò–° ----------------------
async def cmd_health(update: Update, context: ContextTypes.DEFAULT_TYPE):
    await update.message.reply_text("OK")

def main():
    app = (
        ApplicationBuilder()
        .token(TOKEN)
        .parse_mode(ParseMode.HTML)  # HTML —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
        .build()
    )

    app.add_handler(CommandHandler("start", cmd_start))
    app.add_handler(CommandHandler("reset", cmd_reset))
    app.add_handler(CommandHandler("health", cmd_health))
    app.add_handler(MessageHandler(filters.TEXT & ~filters.COMMAND, handle_text))

    log.info("Application started (polling)")
    app.run_polling(close_loop=False)

if __name__ == "__main__":
    main()
