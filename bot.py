# bot.py
import os
import html
import logging
from typing import List, Tuple

from flask import Flask, request
from telegram import Update
from telegram.ext import (
    ApplicationBuilder, CommandHandler, MessageHandler, filters, ContextTypes
)
from openai import OpenAI

# ==== –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è ====
TELEGRAM_BOT_TOKEN = os.getenv("TELEGRAM_BOT_TOKEN")
OPENAI_API_KEY     = os.getenv("OPENAI_API_KEY")
WEBHOOK_BASE       = os.getenv("WEBHOOK_BASE")      # –µ—Å–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—à—å webhook
WEBHOOK_SECRET     = os.getenv("WEBHOOK_SECRET")    # –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ, –º–æ–∂–Ω–æ –æ—Å—Ç–∞–≤–∏—Ç—å –ø—É—Å—Ç—ã–º

# –ë–µ–∑–æ–ø–∞—Å–Ω—ã–π –Ω–µ–π—Ç—Ä–∞–ª—å–Ω—ã–π —Å—Ç–∏–ª—å –∏–¥–µ–Ω—Ç–∏—á–Ω–æ—Å—Ç–∏ ‚Äî –Ω–µ —Ä–∞—Å–∫—Ä—ã–≤–∞–µ–º –ø–ª–∞—Ç—Ñ–æ—Ä–º—ã –∏ –ø—Ä–æ–≤–∞–π–¥–µ—Ä–æ–≤
BOT_NAME = "AILVI_Guide"

# ==== –õ–æ–≥–≥–µ—Ä ====
logging.basicConfig(
    format="%(asctime)s [%(levelname)s] %(message)s",
    level=logging.INFO,
)
log = logging.getLogger("ailvi-bot")

# ==== OpenAI –∫–ª–∏–µ–Ω—Ç ====
client = OpenAI(api_key=OPENAI_API_KEY)

# ==== Flask (–µ—Å–ª–∏ –Ω—É–∂–Ω–æ –¥–µ—Ä–∂–∞—Ç—å –≤–µ–±—Ö—É–∫ –Ω–∞ Render) ====
app = Flask(__name__)

# -----------------------------------------------------------------------------
# –£–¢–ò–õ–ò–¢–´ –§–û–†–ú–ê–¢–ò–†–û–í–ê–ù–ò–Ø (HTML)
# -----------------------------------------------------------------------------

def esc(t: str) -> str:
    """–≠–∫—Ä–∞–Ω–∏—Ä—É–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–π —Ç–µ–∫—Å—Ç, —á—Ç–æ–±—ã HTML Telegram –Ω–µ —Å–ª–æ–º–∞–ª—Å—è."""
    return html.escape(t or "")

def b(t: str) -> str:
    return f"<b>{t}</b>"

def i(t: str) -> str:
    return f"<i>{t}</i>"

def u(t: str) -> str:
    return f"<u>{t}</u>"

def p(*lines: str) -> str:
    """
    –§–æ—Ä–º–∏—Ä—É–µ—Ç –∞–±–∑–∞—Ü: –æ–±—ä–µ–¥–∏–Ω—è–µ—Ç —Å—Ç—Ä–æ–∫–∏, –ø–æ—Å–ª–µ –∞–±–∑–∞—Ü–∞ —Å—Ç–∞–≤–∏—Ç –ø—É—Å—Ç—É—é —Å—Ç—Ä–æ–∫—É.
    –ü—Ä–∏–º–µ—Ä: p(b('–ó–∞–≥–æ–ª–æ–≤–æ–∫'), '–¢–µ–∫—Å—Ç –∞–±–∑–∞—Ü–∞.')
    """
    body = "".join(lines)
    return body + "\n\n"

def bullet(items: List[str]) -> str:
    """–ù—É–º–µ—Ä–∞—Ü–∏—è/–º–∞—Ä–∫–∏—Ä–æ–≤–∫–∞ —Å–æ —Å–ø–æ–∫–æ–π–Ω—ã–º–∏ —ç–º–æ–¥–∑–∏."""
    return "".join(f"‚Ä¢ {item}\n" for item in items) + "\n"

def chunk_telegram(text: str, limit: int = 4096) -> List[str]:
    """–ù–∞—Ä–µ–∑–∞–µ–º –¥–ª–∏–Ω–Ω—ã–π HTML-—Ç–µ–∫—Å—Ç –Ω–∞ –∫—É—Å–∫–∏ –¥–æ –ª–∏–º–∏—Ç–∞ Telegram."""
    parts: List[str] = []
    while len(text) > limit:
        cut = text.rfind("\n", 0, limit)
        if cut == -1:
            cut = limit
        parts.append(text[:cut])
        text = text[cut:]
    parts.append(text)
    return parts

async def send_html(ctx: ContextTypes.DEFAULT_TYPE, chat_id: int, text: str):
    """–û—Ç–ø—Ä–∞–≤–∫–∞ HTML-—Å–æ–æ–±—â–µ–Ω–∏—è —Å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π –Ω–∞—Ä–µ–∑–∫–æ–π –ø–æ –ª–∏–º–∏—Ç—É."""
    for part in chunk_telegram(text):
        await ctx.bot.send_message(chat_id=chat_id, text=part, parse_mode="HTML")

# -----------------------------------------------------------------------------
# –¢–ï–ö–°–¢–´
# -----------------------------------------------------------------------------

WELCOME_TEXT = (
    p(b("–ê—Å—Å–∞–ª—è–º—É –∞–ª–µ–π–∫—É–º! ") + "üëãüèª")
    + p("–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–æ, –≥–¥–µ –°–µ—Ä–¥—Ü–µ —É–∑–Ω–∞—ë—Ç —Å–µ–±—è –∑–∞–Ω–æ–≤–æ.")
    + p("–ü–æ–π–¥—ë–º —Å–ø–æ–∫–æ–π–Ω–æ, –º—è–≥–∫–æ, —à–∞–≥ –∑–∞ —à–∞–≥–æ–º. –Ø –ø–æ–º–æ–≥—É —É–≤–∏–¥–µ—Ç—å —Ç–≤–æ–∏ –ø—Ä–∏—Ä–æ–¥–Ω—ã–µ –¥–∞—Ä—ã, —Ü–µ–Ω–Ω–æ—Å—Ç–∏ –∏ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–ª—É–∂–µ–Ω–∏—è ‚Äî –±–µ–∑ —Å–ø–µ—à–∫–∏ –∏ –±–µ–∑ –¥–∞–≤–ª–µ–Ω–∏—è. üí´")
    + p(i("–ß—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å –≥–ª—É–±–æ–∫—É—é —Ä–∞—Å–ø–∞–∫–æ–≤–∫—É ‚Äî –Ω–∞–ø–∏—à–∏: ") + b("–ù–∞—á–∏–Ω–∞–µ–º"))
)

def first_turn_text() -> str:
    return (
        p(b("–° —Ä–∞–¥–æ—Å—Ç—å—é –Ω–∞—á–∏–Ω–∞—é —Ä–∞—Å–ø–∞–∫–æ–≤–∫—É. ‚ú®"))
        + p(
            i("–†–∞—Å—Å–∫–∞–∂–∏ –º–Ω–µ‚Ä¶")
            + " –ß—Ç–æ —Å–µ–π—á–∞—Å —Å–∞–º–æ–µ –≤–∞–∂–Ω–æ–µ –¥–ª—è —Ç–µ–±—è? "
            + "–≠—Ç–æ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø–æ–∏—Å–∫ —Å–º—ã—Å–ª–∞, —É—Å—Ç–∞–ª–æ—Å—Ç—å, –∂–µ–ª–∞–Ω–∏–µ —è—Å–Ω–æ—Å—Ç–∏ –≤ —Ä–∞–±–æ—Ç–µ, —Ç—è–≥–∞ –∫ –ø–µ—Ä–µ–º–µ–Ω–∞–º –∏–ª–∏ –º–µ—á—Ç–∞, –∫–æ—Ç–æ—Ä–∞—è –Ω–µ –æ—Ç–ø—É—Å–∫–∞–µ—Ç."
        )
        + bullet([
            "¬´–ù–µ –ø–æ–Ω–∏–º–∞—é, –≥–¥–µ –º–æ—è —Å–∏–ª–∞¬ª",
            "¬´–•–æ—á—É —è—Å–Ω–æ—Å—Ç–∏ –≤ —Ä–∞–±–æ—Ç–µ¬ª",
            "¬´–ß—É–≤—Å—Ç–≤—É—é —É—Å—Ç–∞–ª–æ—Å—Ç—å –∏ —Ö–æ—á—É –ø–µ—Ä–µ–º–µ–Ω¬ª",
        ])
        + p("–ú–æ–∂–Ω–æ –∫–æ—Ä–æ—Ç–∫–æ. üåø")
    )

def gentle_followup(user_msg: str) -> str:
    return (
        p(b("–Ø —Ä—è–¥–æ–º.") + " –°–ø–∞—Å–∏–±–æ –∑–∞ –∏—Å–∫—Ä–µ–Ω–Ω–æ—Å—Ç—å. ü§ù")
        + p(
            "–ß—Ç–æ–±—ã –¥–≤–∏–≥–∞—Ç—å—Å—è –≥–ª—É–±–∂–µ, –¥–∞–≤–∞–π –Ω–∞—â—É–ø–∞–µ–º –æ–ø–æ—Ä–Ω—ã–µ —Ç–æ—á–∫–∏. "
            + "–û—Ç–≤–µ—á–∞–π —Ç–∞–∫, –∫–∞–∫ —á—É–≤—Å—Ç–≤—É–µ—à—å ‚Äî –∫–æ—Ä–æ—Ç–∫–æ, –±–µ–∑ –∏–¥–µ–∞–ª—å–Ω–æ—Å—Ç–∏."
        )
        + bullet([
            b("–ß—Ç–æ –ø—Ä–∏–Ω–æ—Å–∏—Ç —Ä–∞–¥–æ—Å—Ç—å?") + " –í—Å–ø–æ–º–Ω–∏ –º–æ–º–µ–Ω—Ç—ã, –∫–æ–≥–¥–∞ –∂–∏–∑–Ω—å –Ω–∞–ø–æ–ª–Ω—è–ª–∞—Å—å —Ç–µ–ø–ª–æ–º. –ö–∞–∫–∏–µ –¥–µ–ª–∞ –∏–ª–∏ —Ä–æ–ª–∏ –¥–∞–≤–∞–ª–∏ –∂–∏–≤—É—é —ç–Ω–µ—Ä–≥–∏—é?",
            b("–ß—Ç–æ –∏–Ω—Ç–µ—Ä–µ—Å—É–µ—Ç?") + " –¢–µ–º—ã, –∫ –∫–æ—Ç–æ—Ä—ã–º —Ç—è–Ω–µ—Ç. –¢–æ, —á—Ç–æ –¥–∞–≤–Ω–æ —Ö–æ—Ç–µ–ª–æ—Å—å –ø–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å.",
            b("–ö–∞–∫ —Ö–æ—á–µ—à—å –ø–æ–º–æ–≥–∞—Ç—å?") + " –ö–æ–º—É –∏ –≤ —á—ë–º —Ç–µ–±–µ –µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω–æ –±—ã—Ç—å –ø–æ–ª–µ–∑(–Ω)—ã–º?",
        ])
        + p(i("–ü–∏—à–∏ –≤ —Å–≤–æ–±–æ–¥–Ω–æ–π —Ñ–æ—Ä–º–µ ‚Äî —è —Å–æ–±–µ—Ä—É –Ω–∏—Ç—å –∏ –ø–æ–≤–µ–¥—É –¥–∞–ª—å—à–µ."))
    )

def format_summary_ready() -> str:
    return (
        p(b("–ú—ã —Å–æ–±—Ä–∞–ª–∏ –æ—Å–Ω–æ–≤—É —Ç–≤–æ–µ–≥–æ –ø—É—Ç–∏. üå±"))
        + p("–•–æ—á–µ—à—å –ø–æ–ª—É—á–∏—Ç—å —Å–∂–∞—Ç—É—é –∫–∞—Ä—Ç—É —Ç–æ–≥–æ, —á—Ç–æ –º—ã –≤—ã—è—Å–Ω–∏–ª–∏: —Ü–µ–Ω–Ω–æ—Å—Ç–∏, —Å–∏–ª—å–Ω—ã–µ —Å—Ç–æ—Ä–æ–Ω—ã, –ø—Ä–∏—Ä–æ–¥–Ω—ã–µ —Ä–æ–ª–∏, —É—Å–ª–æ–≤–∏—è —Å—Ä–µ–¥—ã –∏ –±–ª–∏–∂–∞–π—à–∏–µ —ç–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç—ã?")
        + p(i("–ï—Å–ª–∏ –¥–∞, –Ω–∞–ø–∏—à–∏: ") + b("–î–∞–π –∏—Ç–æ–≥"))
    )

def summary_text(summary: str) -> str:
    return (
        p(b("–ö–∞—Ä—Ç–∞ —Ç–≤–æ–µ–≥–æ –ø—É—Ç–∏ ‚Äî –∫—Ä–∞—Ç–∫–æ –∏ –ø–æ –¥–µ–ª—É. üó∫"))
        + p(summary)
        + p(i("–ì–æ—Ç–æ–≤ –¥–≤–∏–≥–∞—Ç—å—Å—è –∫ –º–∞–ª—ã–º —ç–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç–∞–º? –ù–∞–ø–∏—à–∏: ") + b("–≠–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç—ã"))
    )

# -----------------------------------------------------------------------------
# –ü–†–û–°–¢–ï–ô–®–ï–ï ¬´–°–û–°–¢–û–Ø–ù–ò–ï¬ª –í –ü–ê–ú–Ø–¢–ò –ü–†–û–¶–ï–°–°–ê (–¥–ª—è Render Free –ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—Å—è)
# –î–ª—è –∂–µ–ª–µ–∑–æ–±–µ—Ç–æ–Ω–∞ —É —Ç–µ–±—è —É–∂–µ –ø–æ–¥–Ω—è—Ç PostgreSQL ‚Äî –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—é –º–æ–∂–Ω–æ –≤–∫–ª—é—á–∏—Ç—å.
# –ó–¥–µ—Å—å –æ—Å—Ç–∞–≤–ª—è—é –ª–µ–≥–∫–æ–≤–µ—Å–Ω—É—é –∫–∞—Ä—Ç—É –ø–æ—Å–ª–µ–¥–Ω–∏—Ö —à–∞–≥–æ–≤.
# -----------------------------------------------------------------------------

# chat_id -> simple state
STATE: dict[int, str] = {}

# -----------------------------------------------------------------------------
# –õ–û–ì–ò–ö–ê –î–ò–ê–õ–û–ì–ê
# -----------------------------------------------------------------------------

def is_start(msg: str) -> bool:
    m = (msg or "").strip().lower()
    return m in ("/start", "start", "—Å—Ç–∞—Ä—Ç")

def is_begin(msg: str) -> bool:
    return (msg or "").strip().lower() == "–Ω–∞—á–∏–Ω–∞–µ–º"

def is_summary_request(msg: str) -> bool:
    m = (msg or "").strip().lower()
    return m in ("–¥–∞–π –∏—Ç–æ–≥", "–∏—Ç–æ–≥", "–≤—ã–¥–∞–π –∏—Ç–æ–≥", "–ø–æ–∫–∞–∂–∏ –∏—Ç–æ–≥")

async def handle_start(update: Update, ctx: ContextTypes.DEFAULT_TYPE):
    chat_id = update.effective_chat.id
    STATE[chat_id] = "welcome"
    await send_html(ctx, chat_id, WELCOME_TEXT)

async def handle_message(update: Update, ctx: ContextTypes.DEFAULT_TYPE):
    if not update.message or not update.message.text:
        return
    chat_id = update.effective_chat.id
    user_text = update.message.text

    # –§–∏–ª—å—Ç—Ä –Ω–∞ –ø–æ–ø—ã—Ç–∫–∏ ¬´–∫—Ç–æ —Ç—ã? —Ç—ã chatgpt?¬ª ‚Äî –º—è–≥–∫–∏–π –æ—Ç–∫–∞–∑
    lowered = user_text.lower()
    if any(k in lowered for k in ["chatgpt", "openai", "gpt", "–∫—Ç–æ —Ç—ã", "—Ç—ã –±–æ—Ç", "—Ç—ã —á–∞—Ç–∂–ø—Ç"]):
        reply = (
            p(b("–Ø ‚Äî AILVI_Guide.") + " –Ø —Ä—è–¥–æ–º, —á—Ç–æ–±—ã –º—è–≥–∫–æ –∏ –±–µ—Ä–µ–∂–Ω–æ –≤–µ—Å—Ç–∏ —Ä–∞–∑–≥–æ–≤–æ—Ä –æ —Ç–≤–æ—ë–º –ø—É—Ç–∏. ü§ù")
            + p("–°—Ñ–æ–∫—É—Å–∏—Ä—É–µ–º—Å—è –Ω–∞ —Ç–µ–±–µ –∏ —Ç–≤–æ–∏—Ö —à–∞–≥–∞—Ö ‚Äî —Ç–∞–∫ –±—É–¥–µ—Ç –ø–æ–ª–µ–∑–Ω–µ–µ.")
        )
        await send_html(ctx, chat_id, reply)
        return

    # –í–µ—Ç–≤–ª–µ–Ω–∏–µ –ø–æ —Å–æ—Å—Ç–æ—è–Ω–∏—é / —Ñ—Ä–∞–∑–∞–º:
    if is_start(user_text):
        return await handle_start(update, ctx)

    if is_begin(user_text):
        STATE[chat_id] = "first_turn"
        return await send_html(ctx, chat_id, first_turn_text())

    if is_summary_request(user_text):
        # –ó–¥–µ—Å—å —Ç—ã –º–æ–∂–µ—à—å –ø–æ–¥—Å—Ç–∞–≤–∏—Ç—å —Ä–µ–∞–ª—å–Ω—É—é —Å–±–æ—Ä–∫—É –∏–∑ –ë–î.
        # –ü–æ–∫–∞ —Å–æ–±–µ—Ä—ë–º –∏–∑ –∫—Ä–∞—Ç–∫–æ–π LM-–≤—ã–∂–∏–º–∫–∏ –ø–æ –∏—Å—Ç–æ—Ä–∏–∏ (–¥–µ–º–æ).
        synthesis = build_llm_synthesis(chat_id)
        return await send_html(ctx, chat_id, summary_text(esc(synthesis)))

    # –û—Å–Ω–æ–≤–Ω–æ–π –¥–∏–∞–ª–æ–≥ ‚Äî —Å–Ω–∞—á–∞–ª–∞ –æ—Ç–≤–µ—á–∞–µ–º —Ç—ë–ø–ª—ã–º —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä—É—é—â–∏–º –±–ª–æ–∫–æ–º,
    # –∑–∞—Ç–µ–º ‚Äî –±–µ—Ä—ë–º —Å–º—ã—Å–ª –∏–∑ –º–æ–¥–µ–ª–∏ –∏ –ø–æ–¥–∞—ë–º –º—è–≥–∫—É—é —Å–ª–µ–¥—É—é—â—É—é ¬´—Å—Ç—É–ø–µ–Ω—å–∫—É¬ª.
    state = STATE.get(chat_id, "")
    if state in ("first_turn", "deepening"):
        # 1) –¢—ë–ø–ª—ã–π ¬´–≤–µ–¥—É—â–∏–π¬ª –±–ª–æ–∫ (—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–π)
        if state == "first_turn":
            await send_html(ctx, chat_id, gentle_followup(user_text))
            STATE[chat_id] = "deepening"
            return

        # 2) –î–∞–ª–µ–µ ‚Äî –º–∏–∫—Ä–æ-–ø–µ—Ç–ª—è: –∞–Ω–∞–ª–∏–∑ –æ—Ç–≤–µ—Ç–∞ + —à–∞–≥-–≤–æ–ø—Ä–æ—Å –≤–ø–µ—Ä—ë–¥
        coach_answer = build_llm_step(chat_id, user_text)
        await send_html(ctx, chat_id, coach_answer)

        # –ü–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∏ –ø—Ä–µ–¥–ª–∞–≥–∞–π –∏—Ç–æ–≥, —á—Ç–æ–±—ã —á–µ–ª–æ–≤–µ–∫ –∑–Ω–∞–ª –æ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏
        await send_html(ctx, chat_id, format_summary_ready())
        return

    # –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞–ø–∏—Å–∞–ª —á—Ç–æ-—Ç–æ ¬´—Å –ø—É—Å—Ç–æ–≥–æ –º–µ—Å—Ç–∞¬ª ‚Äî –º—è–≥–∫–æ –∑–∞–ø—É—Å–∫–∞–µ–º –ø–æ—Ç–æ–∫
    await send_html(ctx, chat_id, WELCOME_TEXT)

# -----------------------------------------------------------------------------
# –í–°–ü–û–ú–û–ì–ê–¢–ï–õ–¨–ù–´–ï –í–´–ó–û–í–´ –ú–û–î–ï–õ–ò
# -----------------------------------------------------------------------------

def build_llm_synthesis(chat_id: int) -> str:
    """
    –î–µ–ª–∞–µ–º –∫–æ–º–ø–∞–∫—Ç–Ω—É—é –≤—ã–∂–∏–º–∫—É. –ó–¥–µ—Å—å –º–æ–∂–Ω–æ –ø—Ä–æ–∫–∏–Ω—É—Ç—å –∏—Å—Ç–æ—Ä–∏—é –∏–∑ –ë–î.
    –°–µ–π—á–∞—Å ‚Äî –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–π –ø—Ä–∏–º–µ—Ä: –æ–¥–Ω–∞ –ø–æ–¥—Å–∫–∞–∑–∫–∞, –±–µ–∑ —Ä–∞—Å–∫—Ä—ã—Ç–∏—è –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞.
    """
    prompt = (
        "–°–æ–±–µ—Ä–∏ –∫—Ä–∞—Ç–∫—É—é –∫–∞—Ä—Ç—É –ª–∏—á–Ω–æ—Å—Ç–∏ —á–µ–ª–æ–≤–µ–∫–∞ –Ω–∞ –æ—Å–Ω–æ–≤–µ –Ω–∞—à–∏—Ö –Ω–µ–¥–∞–≤–Ω–∏—Ö —Å–æ–æ–±—â–µ–Ω–∏–π. "
        "–°—Ç—Ä—É–∫—Ç—É—Ä–∞: 1) –¶–µ–Ω–Ω–æ—Å—Ç–∏; 2) –°–∏–ª—å–Ω—ã–µ —Å—Ç–æ—Ä–æ–Ω—ã; 3) –ò–Ω—Ç–µ—Ä–µ—Å—ã/—Å—Ä–µ–¥–∞; "
        "4) –ï—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ —Ä–æ–ª–∏; 5) –†–∏—Å–∫–∏/–¥—Ä–µ–Ω–∞–∂–∏; 6) –ú–∏–∫—Ä–æ-—ç–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç—ã –Ω–∞ 7‚Äì10 –¥–Ω–µ–π. "
        "–ü–∏—à–∏ –ø–æ-—Ä—É—Å—Å–∫–∏, —Å–ø–æ–∫–æ–π–Ω–æ, –±–µ–∑ –∫–æ—É—á-–∫–ª–∏—à–µ. –§–æ—Ä–º–∞—Ç ‚Äî –∫–æ—Ä–æ—Ç–∫–∏–µ –ø—É–Ω–∫—Ç—ã."
    )
    msg = [{"role": "user", "content": prompt}]
    resp = client.chat.completions.create(
        model="gpt-4o-mini",  # –ª—ë–≥–∫–∞—è –∏ –±—ã—Å—Ç—Ä–∞—è –º–æ–¥–µ–ª—å
        messages=msg,
        temperature=0.4,
    )
    text = resp.choices[0].message.content.strip()
    return text

def build_llm_step(chat_id: int, user_text: str) -> str:
    """
    –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –º—è–≥–∫–∏–π —Å–ª–µ–¥—É—é—â–∏–π —à–∞–≥. –í–æ–∑–≤—Ä–∞—â–∞–µ–º —É–∂–µ HTML-–æ—Ç—Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç.
    """
    system = (
        "–¢—ã ‚Äî –±–µ—Ä–µ–∂–Ω—ã–π –¥—É—Ö–æ–≤–Ω–æ-—Å–æ–∑–µ—Ä—Ü–∞—Ç–µ–ª—å–Ω—ã–π –Ω–∞—Å—Ç–∞–≤–Ω–∏–∫. –ù–∏–∫–∞–∫–∏—Ö —É–ø–æ–º–∏–Ω–∞–Ω–∏–π –æ –ø–ª–∞—Ç—Ñ–æ—Ä–º–∞—Ö. "
        "–ì–æ–≤–æ—Ä–∏ –ø–æ-—Ä—É—Å—Å–∫–∏. –¢–æ–Ω: —Ç—ë–ø–ª—ã–π, —Å–ø–æ–∫–æ–π–Ω—ã–π, —Å –¥—ã—Ö–∞–Ω–∏–µ–º, –±–µ–∑ –¥–∞–≤–ª–µ–Ω–∏—è. "
        "–°—Ç—Ä—É–∫—Ç—É—Ä–∞ –æ—Ç–≤–µ—Ç–∞: 1) –∫–æ—Ä–æ—Ç–∫–æ–µ –ø—Ä–∏–∑–Ω–∞–Ω–∏–µ —Å–º—ã—Å–ª–∞ —Å–∫–∞–∑–∞–Ω–Ω–æ–≥–æ; "
        "2) 1‚Äì2 —è—Å–Ω—ã—Ö —É—Ç–æ—á–Ω—è—é—â–∏—Ö –≤–æ–ø—Ä–æ—Å–∞; 3) –æ–¥–Ω–∞ –º–∞–ª–µ–Ω—å–∫–∞—è –ø—Ä–∞–∫—Ç–∏–∫–∞/–Ω–∞–±–ª—é–¥–µ–Ω–∏–µ. "
        "–ù–µ –∏—Å–ø–æ–ª—å–∑—É–π –∑–≤—ë–∑–¥–æ—á–∫–∏ –¥–ª—è —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è ‚Äî –≤–µ—Ä–Ω–∏ —Ä–∞–∑–º–µ—Ç–∫—É –∫–∞–∫ HTML (<b>, <i>, –∞–±–∑–∞—Ü—ã)."
    )
    user = (
        f"–û—Ç–≤–µ—Ç —á–µ–ª–æ–≤–µ–∫–∞: ¬´{user_text}¬ª.\n"
        "–°–¥–µ–ª–∞–π —Å–ª–µ–¥—É—é—â–∏–π –º—è–≥–∫–∏–π —à–∞–≥, —á—Ç–æ–±—ã –≤–µ—Å—Ç–∏ –∫ —Ä–∞—Å–ø–∞–∫–æ–≤–∫–µ —Ü–µ–Ω–Ω–æ—Å—Ç–µ–π/—Ä–æ–ª–µ–π/—Å—Ä–µ–¥—ã, "
        "–∏–∑–±–µ–≥–∞–π —Ä–∞–∑–≥–æ–≤–æ—Ä–æ–≤ –ø—Ä–æ –¥–µ–Ω—å–≥–∏ –¥–æ —Ñ–∏–Ω–∞–ª—å–Ω–æ–≥–æ —Å–∏–Ω—Ç–µ–∑–∞."
    )
    resp = client.chat.completions.create(
        model="gpt-4o-mini",
        messages=[
            {"role": "system", "content": system},
            {"role": "user", "content": user},
        ],
        temperature=0.5,
    )
    raw = resp.choices[0].message.content.strip()

    # –ù–∞ —Å–ª—É—á–∞–π, –µ—Å–ª–∏ –º–æ–¥–µ–ª—å –≤–µ—Ä–Ω—É–ª–∞ –æ–±—ã—á–Ω—ã–π —Ç–µ–∫—Å—Ç ‚Äî –æ–±–µ—Ä–Ω—ë–º –∞–±–∑–∞—Ü–∞–º–∏.
    # (–í –∏–¥–µ–∞–ª–µ –æ–Ω–∞ —É–∂–µ –≤–µ—Ä–Ω—ë—Ç HTML. –ù–æ –ø–æ–¥—Å—Ç—Ä–∞—Ö—É–µ–º—Å—è.)
    if "<b>" not in raw and "<i>" not in raw and "<u>" not in raw:
        raw = p(b("–°–ª—ã—à—É —Ç–µ–±—è.")) + p(esc(raw))

    return raw

# -----------------------------------------------------------------------------
# TELEGRAM HANDLERS
# -----------------------------------------------------------------------------

async def cmd_start(update: Update, ctx: ContextTypes.DEFAULT_TYPE):
    await handle_start(update, ctx)

async def on_text(update: Update, ctx: ContextTypes.DEFAULT_TYPE):
    await handle_message(update, ctx)

def build_app():
    application = ApplicationBuilder().token(TELEGRAM_BOT_TOKEN).build()
    application.add_handler(CommandHandler("start", cmd_start))
    application.add_handler(MessageHandler(filters.TEXT & ~filters.COMMAND, on_text))
    return application

# -----------------------------------------------------------------------------
# POINTS OF ENTRY
# -----------------------------------------------------------------------------

telegram_app = build_app()

@app.route("/", methods=["GET"])
def health():
    return "ok", 200

@app.route("/hook", methods=["POST"])
def webhook():
    update = Update.de_json(request.get_json(force=True), telegram_app.bot)
    telegram_app.update_queue.put_nowait(update)
    return "ok", 200

def run_polling():
    telegram_app.run_polling(allowed_updates=Update.ALL_TYPES)

if __name__ == "__main__":
    # –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é ‚Äî polling (–¥–ª—è —Ñ—Ä–∏-–ø–ª–∞–Ω–∞ Render —É–¥–æ–±–Ω–æ).
    # –ï—Å–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—à—å –≤–µ–±—Ö—É–∫, –ø—Ä–æ—Å—Ç–æ –Ω–∞—Å—Ç—Ä–æ–π –º–∞—Ä—à—Ä—É—Ç /hook –∏ –≤–∫–ª—é—á–∏ –≤ Render.
    log.info("Starting bot in polling mode‚Ä¶")
    run_polling()
