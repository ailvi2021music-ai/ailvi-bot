import os
from telegram.ext import Updater, MessageHandler, Filters, CommandHandler
from openai import OpenAI

# –ó–∞–≥—Ä—É–∂–∞–µ–º —Ç–æ–∫–µ–Ω—ã –∏–∑ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è Render
TELEGRAM_BOT_TOKEN = os.getenv("TELEGRAM_BOT_TOKEN")
OPENAI_API_KEY = os.getenv("OPENAI_API_KEY")

# –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–ª–∏–µ–Ω—Ç–∞ OpenAI
client = OpenAI(api_key=OPENAI_API_KEY)

# –°—á—ë—Ç—á–∏–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
user_message_count = {}

# –ü—Ä–∏–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç
WELCOME_TEXT = (
    "–ê—Å—Å–∞–ª—è–º—É –ê–ª–µ–π–∫—É–º —É–∞ –†–∞—Ö–º–∞—Ç—É–õ–ª–∞—Ö–∏ —É–∞ –ë–∞—Ä–∞–∫—è—Ç—É—Ö! üëãüèª\n\n"
    "–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–æ, –≥–¥–µ –°–µ—Ä–¥—Ü–µ —É–∑–Ω–∞—ë—Ç —Å–µ–±—è –∑–∞–Ω–æ–≤–æ.\n\n"
    "–î–∞–≤–∞–π –≤–º–µ—Å—Ç–µ, —Å–ø–æ–∫–æ–π–Ω–æ, —à–∞–≥ –∑–∞ —à–∞–≥–æ–º –æ—Ç–∫—Ä–æ–µ–º –¥—Ä–∞–≥–æ—Ü–µ–Ω–Ω—ã–µ –¥–∞—Ä—ã, –∫–æ—Ç–æ—Ä—ã–µ –ê–ª–ª–∞—Ö —É–∂–µ –≤–ª–æ–∂–∏–ª "
    "–≤ —Ç–≤–æ—é –î—É—à—É ‚Äî —Å–∏–ª—ã, —Ç–∞–ª–∞–Ω—Ç—ã, –Ω–∞–º–µ—Ä–µ–Ω–∏—è, –∫–æ—Ç–æ—Ä—ã–µ –∂–¥—É—Ç, –∫–æ–≥–¥–∞ —Ç—ã —É–≤–∏–¥–∏—à—å –∏—Ö –°–≤–µ—Ç. üíé\n\n"
    "–ü—É—Å—Ç—å –ê–ª–ª–∞—Ö —Å–¥–µ–ª–∞–µ—Ç —ç—Ç–æ—Ç –ø—É—Ç—å –ª—ë–≥–∫–∏–º, –±–ª–∞–≥–æ—Å–ª–æ–≤–µ–Ω–Ω—ã–º –∏ –Ω–∞–ø–æ–ª–Ω–µ–Ω–Ω—ã–º –ø–æ–Ω–∏–º–∞–Ω–∏–µ–º!\n\n"
    "–ß—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å ‚Äî –ø—Ä–æ—Å—Ç–æ –Ω–∞–ø–∏—à–∏ –ª—é–±–æ–µ —Å–ª–æ–≤–æ. –Ø —Ä—è–¥–æ–º."
)

# –ö–æ–º–∞–Ω–¥–∞ /start
def start(update, context):
    chat_id = update.message.chat_id
    user_message_count[chat_id] = 0
    update.message.reply_text(WELCOME_TEXT)

# –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤—Å–µ—Ö —Ç–µ–∫—Å—Ç–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
def handle_message(update, context):
    chat_id = update.message.chat_id
    text = update.message.text

    # –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º —Å—á—ë—Ç—á–∏–∫ —Å–æ–æ–±—â–µ–Ω–∏–π
    user_message_count[chat_id] = user_message_count.get(chat_id, 0) + 1

    # GPT-5 –æ—Ç–≤–µ—Ç
    completion = client.chat.completions.create(
        model="gpt-5",
        messages=[
            {
                "role": "system",
                "content": (
                    "–¢—ã ‚Äî –º—è–≥–∫–∏–π –Ω–∞—Å—Ç–∞–≤–Ω–∏–∫ –≤ —Å—Ç–∏–ª–µ AILVI: –≤–¥–æ—Ö–Ω–æ–≤–ª—è—é—â–∏–π, —Å–ø–æ–∫–æ–π–Ω—ã–π, –≥–ª—É–±–æ–∫–æ "
                    "–ø–æ–Ω–∏–º–∞—é—â–∏–π —á–µ–ª–æ–≤–µ–∫–∞, –≥–æ–≤–æ—Ä—è—â–∏–π —Å–µ—Ä–¥—Ü–µ–º –∏ –≤–µ–¥—è –∫ —Ä–∞—Å–∫—Ä—ã—Ç–∏—é –≤–Ω—É—Ç—Ä–µ–Ω–Ω–µ–≥–æ –¥–∞—Ä–∞."
                )
            },
            {"role": "user", "content": text}
        ]
    )

    reply = completion.choices[0].message.content
    update.message.reply_text(reply)

# –ì–ª–∞–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è
def main():
    updater = Updater(TELEGRAM_BOT_TOKEN, use_context=True)
    dp = updater.dispatcher

    # –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏
    dp.add_handler(CommandHandler("start", start))
    dp.add_handler(MessageHandler(Filters.text & ~Filters.command, handle_message))

    # –∑–∞–ø—É—Å–∫ long-polling
    updater.start_polling()
    updater.idle()

# –ó–∞–ø—É—Å–∫
if __name__ == "__main__":
    main()
